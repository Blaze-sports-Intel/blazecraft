import{C as hs,V as F,M as ee,T as ne,Q as Fe,S as pt,a as H,R as ds,P as us,b as Ht,D as ps,H as xe,F as je,c as Me,L as X,d as de,A as $t,e as _e,E as ms,f as Ut,g as ve,h as fs,i as jt,j as gs,k as ys,l as te,m as bs,n as z,o as B,G as ws,O as Wt,W as _s,p as As,q as Ts,r as Ss,s as Es,t as vs,u as xs,v as nt,w as zt,x as Kt,y as Ae,z as Be,B as Y,I as oe,J as Ms,K as ks,N as Ge,U as Rs,X as Ls,Y as Xt,Z as Is,_ as Te,$ as Ps,a0 as qt,a1 as Cs,a2 as Ds,a3 as Ns,a4 as Yt,a5 as Os,a6 as Fs,a7 as Vt,a8 as Oe,a9 as Bs,aa as He,ab as K,ac as Gs,ad as ht,ae as Hs,af as $s,ag as Us,ah as js,ai as Zt,aj as Se,ak as Ws,al as zs,am as Ks,an as Xs,ao as qs,ap as Qt,aq as Ys,ar as mt,as as ft,at as gt,au as yt,av as ot,aw as Vs,ax as Zs,ay as Qs,az as Js,aA as Jt,aB as es,aC as ei,aD as We,aE as ti,aF as si,aG as ii,aH as ni}from"./three-MAxUgDHy.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class oi{constructor(){this.workers=new Map,this.events=[],this.selected=new Set,this.startedAt=Date.now(),this.scout=["No threats detected.","Demo mode is generating worker activity."],this.stats={completed:0,files:0,failed:0,tokens:0},this.eventStats={spawns:0,commands:0,production:0,research:0,repairs:0,storage:0,defense:0},this.listeners=new Set}bumpCompleted(e){this.stats.completed+=e,this.notify()}bumpFiles(e){this.stats.files+=e,this.notify()}bumpFailed(e){this.stats.failed+=e,this.notify()}pushScoutLine(e){this.scout=[e,...this.scout].slice(0,3),this.notify()}subscribe(e){return this.listeners.add(e),e(this),()=>this.listeners.delete(e)}notify(){for(const e of this.listeners)e(this)}pushEvent(e){this.trackEventCategory(e),this.events.unshift(e),this.events.length>250&&(this.events.length=250),this.notify()}trackEventCategory(e){switch(e.type){case"spawn":this.eventStats.spawns++;break;case"command":this.eventStats.commands++;break;case"error":case"injury":this.eventStats.repairs++;break;case"status":this.eventStats.defense++;break;case"sports_update":case"highlight":this.eventStats.production++;break;case"sports_final":this.eventStats.commands++;break;case"task_start":case"task_complete":e.category?this.bumpEventCategory(e.category):this.inferAndBumpCategory(e.details);break}}bumpEventCategory(e){switch(e){case"command":this.eventStats.commands++;break;case"production":this.eventStats.production++;break;case"research":this.eventStats.research++;break;case"repair":this.eventStats.repairs++;break;case"storage":this.eventStats.storage++;break;case"defense":this.eventStats.defense++;break;default:this.eventStats.production++}}inferAndBumpCategory(e){const t=e.toLowerCase();t.includes("fix")||t.includes("bug")||t.includes("error")||t.includes("conflict")?this.eventStats.repairs++:t.includes("test")||t.includes("investigate")||t.includes("research")||t.includes("analyze")?this.eventStats.research++:t.includes("refactor")||t.includes("wire")||t.includes("add")||t.includes("component")?this.eventStats.production++:t.includes("extract")||t.includes("store")||t.includes("archive")||t.includes("data")?this.eventStats.storage++:t.includes("monitor")||t.includes("patrol")||t.includes("scout")||t.includes("watch")?this.eventStats.defense++:t.includes("assign")||t.includes("command")||t.includes("order")?this.eventStats.commands++:this.eventStats.production++}getEventStats(){return{...this.eventStats}}upsertWorker(e){this.workers.set(e.id,e),this.notify()}removeWorker(e){this.workers.delete(e),this.selected.delete(e),this.notify()}setSelected(e){this.selected=new Set(e),this.notify()}getSelectedWorkers(){const e=[];for(const t of this.selected){const i=this.workers.get(t);i&&e.push(i)}return e}getIdleOrBlocked(){const e=[];for(const t of this.workers.values())(t.status==="idle"||t.status==="blocked")&&e.push(t);return e}tickStats(){let e=0;for(const t of this.workers.values())e+=t.tokensUsed;this.stats.tokens=e}getSessionDurationMs(){return Date.now()-this.startedAt}}function bt(r){const e=Math.max(0,Math.floor(r/1e3)),t=Math.floor(e/60),i=e%60;return`${String(t).padStart(2,"0")}:${String(i).padStart(2,"0")}`}const me=[{id:"townhall",name:"Town Hall",type:"townhall",bounds:{x:540,y:280,width:240,height:180}},{id:"src_core",name:"src/core",type:"goldmine",bounds:{x:180,y:170,width:260,height:180}},{id:"src_ui",name:"src/ui",type:"goldmine",bounds:{x:860,y:150,width:260,height:170}},{id:"tests",name:"tests",type:"lumber",bounds:{x:850,y:400,width:280,height:160}},{id:"config",name:"config",type:"lumber",bounds:{x:190,y:390,width:240,height:150}},{id:"docs",name:"docs",type:"ground",bounds:{x:460,y:500,width:360,height:140}}];function ri(r,e){for(const t of me){const i=t.bounds;if(r>=i.x&&r<=i.x+i.width&&e>=i.y&&e<=i.y+i.height)return t}return null}function ke(r){const e=r.bounds,t=18;return{x:e.x+t+Math.random()*(e.width-t*2),y:e.y+t+Math.random()*(e.height-t*2)}}function le(r,e,t){return Math.max(e,Math.min(t,r))}const ts={S:0};function ai(r,e){if(r===0&&e===0)return ts.S;const t=Math.atan2(e,r),i=t<0?t+Math.PI*2:t;return(Math.round(i/(Math.PI/4))%8+2)%8}class ci{constructor(){this.cache=new Map,this.loaded=!1,this.loadPromise=null,this.basePath="assets/sprites"}async preload(){return this.loadPromise?this.loadPromise:(this.loadPromise=this._loadAll(),await this.loadPromise,this.loaded=!0,this.loadPromise)}async _loadAll(){const e=[];for(let i=0;i<8;i++)e.push(this._loadImage(`units/worker_d${i}.png`,`worker_d${i}`));const t=["townhall_t1","townhall_t2","townhall_t3","barracks","farm","forge","library","tower","tower_b","workshop","archive","granary"];for(const i of t)e.push(this._loadImage(`buildings/${i}.png`,`building_${i}`));await Promise.all(e)}_loadImage(e,t){return new Promise((i,s)=>{const n=new Image;n.onload=()=>{this.cache.set(t,n),i(n)},n.onerror=()=>{console.warn(`Failed to load sprite: ${e}`),i(n)},n.src=`${this.basePath}/${e}`})}getWorkerSprite(e){return this.cache.get(`worker_d${e}`)||null}getBuildingSprite(e,t=1){if(e==="townhall")return this.cache.get(`building_townhall_t${t}`)||null;const s={barracks:"barracks",farm:"farm",forge:"forge",library:"library",tower:t>=2?"tower_b":"tower",workshop:"workshop",archive:"archive"}[e]||e;return this.cache.get(`building_${s}`)||null}}function li(r,e,t,i,s,n={}){const{scale:o=1,alpha:a=1,tint:c,bob:l=0}=n,h=e.getWorkerSprite(s);if(!h||!h.complete){r.beginPath(),r.fillStyle=c||"rgba(244,244,247,0.7)",r.arc(t,i+l,7.5,0,Math.PI*2),r.fill();return}const d=h.width*o,u=h.height*o;r.save(),r.globalAlpha=a,r.drawImage(h,t-d/2,i-u/2+l,d,u),c&&(r.globalCompositeOperation="source-atop",r.fillStyle=c,r.globalAlpha=.3,r.fillRect(t-d/2,i-u/2+l,d,u)),r.restore()}function hi(r,e,t,i,s,n,o={}){const{scale:a=1,alpha:c=1}=o,l=e.getBuildingSprite(s,n);if(!l||!l.complete){r.fillStyle="rgba(30,30,35,0.8)",r.fillRect(t-48,i-36,96,72);return}const h=l.width*a,d=l.height*a;r.save(),r.globalAlpha=c,r.drawImage(l,t-h/2,i-d/2,h,d),r.restore()}const $e=new ci,Ee={townhall:{name:["Town Hall","Keep","Fortress"],baseSize:{w:96,h:72},eventKey:"spawns",tiers:[{eventsRequired:0,color:"#1A1A1A",accent:"#BF5700"},{eventsRequired:5,color:"#1F1F1F",accent:"#D96B1A"},{eventsRequired:12,color:"#242424",accent:"#FF6B35"}]},barracks:{name:["Barracks","War Hall","Command Center"],baseSize:{w:64,h:56},eventKey:"commands",tiers:[{eventsRequired:2,color:"#1A1614",accent:"#8B4513"},{eventsRequired:8,color:"#1F1A16",accent:"#A0522D"},{eventsRequired:18,color:"#24201A",accent:"#CD853F"}]},farm:{name:["Farm","Mill","Granary"],baseSize:{w:52,h:44},eventKey:"production",tiers:[{eventsRequired:2,color:"#141A14",accent:"#2E8B57"},{eventsRequired:10,color:"#161F16",accent:"#3CB371"},{eventsRequired:22,color:"#1A241A",accent:"#66CDAA"}]},forge:{name:["Forge","Armory","War Factory"],baseSize:{w:56,h:48},eventKey:"repairs",tiers:[{eventsRequired:1,color:"#1A1414",accent:"#8B0000"},{eventsRequired:5,color:"#1F1616",accent:"#B22222"},{eventsRequired:12,color:"#241A1A",accent:"#DC143C"}]},library:{name:["Library","Archives","Sanctum"],baseSize:{w:58,h:50},eventKey:"research",tiers:[{eventsRequired:2,color:"#14141A",accent:"#4169E1"},{eventsRequired:8,color:"#16161F",accent:"#6495ED"},{eventsRequired:16,color:"#1A1A24",accent:"#87CEEB"}]},tower:{name:["Scout Tower","Guard Tower","Citadel"],baseSize:{w:36,h:36},eventKey:"defense",tiers:[{eventsRequired:3,color:"#181818",accent:"#696969"},{eventsRequired:12,color:"#1C1C1C",accent:"#808080"},{eventsRequired:25,color:"#202020",accent:"#A9A9A9"}]},workshop:{name:["Workshop","Factory","Foundry"],baseSize:{w:60,h:52},eventKey:"production",tiers:[{eventsRequired:4,color:"#1A1816",accent:"#DAA520"},{eventsRequired:14,color:"#1F1C18",accent:"#FFD700"},{eventsRequired:28,color:"#24201A",accent:"#FFA500"}]},archive:{name:["Archive","Repository","Nexus"],baseSize:{w:48,h:40},eventKey:"storage",tiers:[{eventsRequired:2,color:"#161618",accent:"#9932CC"},{eventsRequired:8,color:"#1A1A1C",accent:"#BA55D3"},{eventsRequired:18,color:"#1E1E22",accent:"#DA70D6"}]}},ze=[{type:"townhall",offset:{x:0,y:0},priority:0},{type:"barracks",offset:{x:-110,y:-60},priority:1},{type:"farm",offset:{x:110,y:-50},priority:2},{type:"forge",offset:{x:-100,y:70},priority:3},{type:"library",offset:{x:100,y:60},priority:4},{type:"tower",offset:{x:-160,y:0},priority:5},{type:"tower",offset:{x:160,y:0},priority:6},{type:"workshop",offset:{x:0,y:-100},priority:7},{type:"archive",offset:{x:0,y:100},priority:8}];class di{constructor(e=660,t=370){this.buildings=new Map,this.centerX=e,this.centerY=t,this.cityLevel=0,this.lastTaskCount=0,this.spawnBuilding("townhall",0)}spawnBuilding(e,t){const i=ze[t],s=Ee[e],n=Date.now(),o={id:`${e}_${t}`,type:e,tier:1,position:{x:this.centerX+i.offset.x,y:this.centerY+i.offset.y},size:{...s.baseSize},constructionProgress:e==="townhall"?100:0,isConstructing:e!=="townhall",spawnedAt:n,lastActivity:n};return this.buildings.set(o.id,o),o}updateProgress(e){const t=Date.now(),i=Object.values(e).reduce((s,n)=>s+n,0);for(let s=0;s<ze.length;s++){const n=ze[s],o=Ee[n.type],a=o.tiers[0],c=`${n.type}_${s}`;(e[o.eventKey]||0)>=a.eventsRequired&&!this.buildings.has(c)&&this.spawnBuilding(n.type,s)}for(const s of this.buildings.values()){const n=Ee[s.type],o=e[n.eventKey]||0;s.isConstructing&&(s.constructionProgress+=2,s.constructionProgress>=100&&(s.constructionProgress=100,s.isConstructing=!1));for(let a=2;a>=0;a--){const c=n.tiers[a];if(o>=c.eventsRequired&&s.tier<=a){s.tier<a+1&&(s.tier=a+1,s.lastActivity=t,s.size.w=n.baseSize.w+a*8,s.size.h=n.baseSize.h+a*6);break}}}this.cityLevel=this.calculateCityLevel(i),this.lastTaskCount=i}calculateCityLevel(e){return e>=80?5:e>=50?4:e>=25?3:e>=10?2:1}getAllBuildings(){return Array.from(this.buildings.values())}getBuilding(e){return this.buildings.get(e)}getCityStats(){const e=this.getAllBuildings(),t=e.filter(s=>!s.isConstructing).length,i=Math.max(...e.map(s=>s.tier),1);return{level:this.cityLevel,buildingsTotal:e.length,buildingsConstructed:t,maxTier:i}}}function ui(r,e,t){const i=Ee[e.type],s=e.tier-1,n=i.tiers[s],o=i.name[s],{x:a,y:c}=e.position,{w:l,h}=e.size;r.save();const d=e.isConstructing?.4+e.constructionProgress/100*.6:1;if(r.fillStyle="rgba(0,0,0,0.35)",r.beginPath(),r.ellipse(a,c+40,44,16,0,0,Math.PI*2),r.fill(),$e.loaded)hi(r,$e,a,c,e.type,e.tier,{scale:1+(e.tier-1)*.1,alpha:d});else{r.globalAlpha=d;const p=r.createLinearGradient(a-l/2,c-h/2,a+l/2,c+h/2);p.addColorStop(0,n.color),p.addColorStop(1,mi(n.color,-20)),r.fillStyle=p,r.fillRect(a-l/2,c-h/2,l,h),r.strokeStyle=n.accent,r.lineWidth=2+(e.tier-1)*.5,r.strokeRect(a-l/2,c-h/2,l,h),r.fillStyle=n.accent,r.font=`${14+e.tier*2}px Inter, system-ui, sans-serif`,r.textAlign="center",r.textBaseline="middle",r.fillText(pi(e.type),a,c-4)}if(r.globalAlpha=d,r.font="11px Inter, system-ui, sans-serif",r.fillStyle="rgba(255,255,255,0.85)",r.textAlign="center",r.shadowColor="rgba(0,0,0,0.9)",r.shadowBlur=4,r.fillText(o,a,c+56),e.isConstructing){const y=a-36,g=c+65;r.fillStyle="rgba(0,0,0,0.6)",r.fillRect(y,g,72,4),r.fillStyle="#BF5700",r.fillRect(y,g,72*(e.constructionProgress/100),4)}if(t-e.lastActivity<3e3&&!e.isConstructing){const p=Math.sin(t/200)*.3+.7;r.strokeStyle=fi(n.accent,p*.6),r.lineWidth=3,r.beginPath(),r.arc(a,c,50+e.tier*4,0,Math.PI*2),r.stroke()}r.restore()}function pi(r){return{townhall:"â›«",barracks:"âš”",farm:"âš˜",forge:"âš’",library:"ðŸ“œ",tower:"â›‰",workshop:"âš™",archive:"â—‰"}[r]||"â—»"}function mi(r,e){const t=parseInt(r.replace("#",""),16),i=Math.max(0,Math.min(255,(t>>16&255)+e)),s=Math.max(0,Math.min(255,(t>>8&255)+e)),n=Math.max(0,Math.min(255,(t&255)+e));return`rgb(${i},${s},${n})`}function fi(r,e){const t=parseInt(r.replace("#",""),16),i=t>>16&255,s=t>>8&255,n=t&255;return`rgba(${i},${s},${n},${e})`}class gi{constructor(e,t){this.mapCanvas=e,this.minimapCanvas=t,this.ctx=e?e.getContext("2d",{alpha:!1}):null,this.mctx=t.getContext("2d",{alpha:!1}),this.dpr=Math.max(1,window.devicePixelRatio||1),this.camera={x:0,y:0,zoom:1},this.selection={active:!1,x0:0,y0:0,x1:0,y1:0},this.texNoise=null,this.lastEventTs=0,this.pings=[],this.regionActivity=new Map,this.cityManager=null,this.world={w:1280,h:720},this.resize(),window.addEventListener("resize",()=>this.resize())}setCityManager(e){this.cityManager=e}async loadTextures(e){const t=e||(()=>{});let i=0;const s=2,n=o=>new Promise((a,c)=>{const l=new Image;l.onload=()=>a(l),l.onerror=c,l.src=o});try{this.texNoise=await n("styles/textures/noise.png")}catch{this.texNoise=null}i++,t(i/s);try{await $e.preload(),this.spritesLoaded=!0}catch{this.spritesLoaded=!1}i++,t(i/s)}resize(){if(this.mapCanvas&&this.ctx){const s=this.mapCanvas.getBoundingClientRect(),n=Math.max(320,Math.floor(s.width)),o=Math.max(240,Math.floor(s.height));this.mapCanvas.width=Math.floor(n*this.dpr),this.mapCanvas.height=Math.floor(o*this.dpr),this.mapCanvas.style.width=`${n}px`,this.mapCanvas.style.height=`${o}px`,this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0)}const e=this.minimapCanvas.getBoundingClientRect(),t=Math.floor(e.width),i=Math.floor(e.height);this.minimapCanvas.width=Math.floor(t*this.dpr),this.minimapCanvas.height=Math.floor(i*this.dpr),this.minimapCanvas.style.width=`${t}px`,this.minimapCanvas.style.height=`${i}px`,this.mctx.setTransform(this.dpr,0,0,this.dpr,0,0)}screenToWorld(e,t){const i=this.mapCanvas.getBoundingClientRect(),s=e-i.left,n=t-i.top,o=s-i.width/2,a=n-i.height/2,c=o/this.camera.zoom+this.camera.x,l=a/this.camera.zoom+this.camera.y;return{x:c,y:l}}worldToScreen(e,t){const i=this.mapCanvas.getBoundingClientRect(),s=(e-this.camera.x)*this.camera.zoom+i.width/2,n=(t-this.camera.y)*this.camera.zoom+i.height/2;return{x:s,y:n}}setSelection(e,t,i,s,n){this.selection.active=e,this.selection.x0=t,this.selection.y0=i,this.selection.x1=s,this.selection.y1=n}addPing(e,t,i){this.pings.push({x:e,y:t,kind:i,t:performance.now()}),this.pings.length>32&&this.pings.shift()}render(e){const t=performance.now();for(const i of e.workers.values()){const s=this.regionActivity.get(i.targetRegion)||0;this.regionActivity.set(i.targetRegion,Math.max(s,i.updatedAt))}if(e.events.length){const i=e.events[e.events.length-1];if(i.timestamp>this.lastEventTs){this.lastEventTs=i.timestamp;const s=e.workers.get(i.workerId);s&&(i.type==="spawn"&&this.addPing(s.position.x,s.position.y,"spawn"),i.type==="error"&&this.addPing(s.position.x,s.position.y,"error"))}}if(this.mapCanvas&&this.ctx){const i=this.mapCanvas.getBoundingClientRect();this.ctx.clearRect(0,0,i.width,i.height),this.drawBackground(i.width,i.height),this.ctx.save(),this.ctx.translate(i.width/2,i.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),this.ctx.fillStyle="rgba(0,0,0,0.22)",this.ctx.fillRect(0,0,this.world.w,this.world.h);for(const s of me)this.drawRegion(s,t);if(this.cityManager)for(const s of this.cityManager.getAllBuildings())ui(this.ctx,s,t);for(const s of this.pings)this.drawPing(s,t);for(const s of e.workers.values())this.drawWorker(s,e.selected.has(s.id),t);if(this.selection.active){this.ctx.save(),this.ctx.strokeStyle="rgba(232,108,44,0.85)",this.ctx.lineWidth=2/this.camera.zoom,this.ctx.setLineDash([6/this.camera.zoom,4/this.camera.zoom]);const s=Math.min(this.selection.x0,this.selection.x1),n=Math.min(this.selection.y0,this.selection.y1),o=Math.abs(this.selection.x1-this.selection.x0),a=Math.abs(this.selection.y1-this.selection.y0);this.ctx.strokeRect(s,n,o,a),this.ctx.restore()}this.ctx.restore()}this.drawMinimap(e)}drawBackground(e,t){const i=this.ctx;i.fillStyle="#0b0b0f",i.fillRect(0,0,e,t);const s=i.createRadialGradient(e*.22,t*.12,20,e*.22,t*.12,Math.max(e,t)*.85);s.addColorStop(0,"rgba(232,108,44,0.18)"),s.addColorStop(1,"rgba(232,108,44,0)"),i.fillStyle=s,i.fillRect(0,0,e,t),i.save(),i.globalAlpha=.25,i.strokeStyle="rgba(255,255,255,0.06)",i.lineWidth=1;const n=48;for(let a=0;a<=e;a+=n)i.beginPath(),i.moveTo(a+.5,0),i.lineTo(a+.5,t),i.stroke();for(let a=0;a<=t;a+=n)i.beginPath(),i.moveTo(0,a+.5),i.lineTo(e,a+.5),i.stroke();if(i.restore(),this.texNoise){const a=i.createPattern(this.texNoise,"repeat");a&&(i.save(),i.globalAlpha=.16,i.fillStyle=a,i.fillRect(0,0,e,t),i.restore())}const o=i.createRadialGradient(e*.5,t*.5,30,e*.5,t*.5,Math.max(e,t));o.addColorStop(0,"rgba(0,0,0,0.08)"),o.addColorStop(1,"rgba(0,0,0,0.72)"),i.fillStyle=o,i.fillRect(0,0,e,t)}drawRegion(e,t){const i=this.ctx,s=e.bounds,n={townhall:{fill:"rgba(18,18,26,0.78)",edge:"rgba(232,108,44,0.82)"},goldmine:{fill:"rgba(30,20,16,0.72)",edge:"rgba(255,177,122,0.70)"},lumber:{fill:"rgba(16,26,20,0.66)",edge:"rgba(55,214,122,0.62)"},ground:{fill:"rgba(14,14,18,0.58)",edge:"rgba(255,255,255,0.10)"}}[e.type];i.save(),i.fillStyle="rgba(0,0,0,0.52)",i.fillRect(s.x+5,s.y+6,s.width,s.height),i.restore(),i.save(),i.fillStyle=n.fill,i.fillRect(s.x,s.y,s.width,s.height),i.strokeStyle=n.edge,i.lineWidth=2,i.strokeRect(s.x,s.y,s.width,s.height),i.strokeStyle="rgba(0,0,0,0.55)",i.lineWidth=2,i.strokeRect(s.x+2,s.y+2,s.width-4,s.height-4),i.font="600 14px Inter, system-ui, sans-serif",i.fillStyle="rgba(244,244,247,0.86)",i.shadowColor="rgba(0,0,0,0.9)",i.shadowBlur=6,i.fillText(e.name,s.x+12,s.y+22),i.restore();const o=this.regionActivity.get(e.id)||0,a=Date.now()-o;if(o&&a<5e3){const c=t/1e3%1;i.save(),i.globalAlpha=(1-a/5e3)*.65,i.strokeStyle="rgba(55,214,122,0.75)",i.lineWidth=2,i.strokeRect(s.x+4+c*6,s.y+4+c*6,s.width-8-c*12,s.height-8-c*12),i.restore()}}drawWorker(e,t,i){var f,y;const s=this.ctx,n=e.position.x,o=e.position.y,a=((f=e.velocity)==null?void 0:f.x)||0,c=((y=e.velocity)==null?void 0:y.y)||0,l=e.status==="moving"?ai(a,c):e.lastDirection||ts.S;e.status==="moving"&&(e.lastDirection=l);const h=Math.sin(i/250+(n+o)*.01)*1.6,d={idle:null,moving:null,working:"rgba(55,214,122,0.4)",blocked:"rgba(255,77,77,0.4)",complete:"rgba(55,214,122,0.3)",terminated:"rgba(80,80,90,0.6)",hold:"rgba(247,201,72,0.3)"},u=e.status==="terminated"?.5:1;if(t&&(s.save(),s.beginPath(),s.strokeStyle="rgba(232,108,44,0.92)",s.lineWidth=3,s.arc(n,o+h,36,0,Math.PI*2),s.stroke(),s.restore()),this.spritesLoaded)li(s,$e,n,o,l,{scale:1,alpha:u,tint:d[e.status],bob:h});else{const g={idle:"rgba(244,244,247,0.70)",moving:"rgba(255,177,122,0.95)",working:"rgba(55,214,122,0.95)",blocked:"rgba(255,77,77,0.95)",complete:"rgba(55,214,122,0.95)",terminated:"rgba(140,140,150,0.55)",hold:"rgba(247,201,72,0.95)"}[e.status]||"rgba(244,244,247,0.85)";s.save(),s.beginPath(),s.fillStyle=g,s.arc(n,o+h,7.5,0,Math.PI*2),s.fill(),s.restore()}s.save(),s.beginPath(),s.fillStyle="rgba(0,0,0,0.60)",s.arc(n+24,o+h-24,5,0,Math.PI*2),s.fill();const p=e.status==="working"?"rgba(55,214,122,1)":e.status==="blocked"?"rgba(255,77,77,1)":e.status==="hold"?"rgba(247,201,72,1)":e.status==="moving"?"rgba(255,177,122,1)":"rgba(244,244,247,0.95)";if(s.beginPath(),s.fillStyle=p,s.arc(n+24,o+h-24,3,0,Math.PI*2),s.fill(),s.restore(),e.status==="working"){s.save(),s.strokeStyle="rgba(232,108,44,0.78)",s.lineWidth=2;const g=i/120%1;s.beginPath(),s.moveTo(n-20,o+h-10),s.lineTo(n-10-g*10,o+h-4),s.stroke(),s.restore()}e.status==="blocked"&&(s.save(),s.strokeStyle="rgba(255,77,77,0.75)",s.lineWidth=2,s.beginPath(),s.arc(n,o+h,38,0,Math.PI*2),s.stroke(),s.restore()),e.status==="complete"&&(s.save(),s.strokeStyle="rgba(244,244,247,0.95)",s.lineWidth=3,s.beginPath(),s.moveTo(n-8,o+h),s.lineTo(n-2,o+h+6),s.lineTo(n+12,o+h-8),s.stroke(),s.restore()),s.save(),s.font="12px Inter, system-ui, sans-serif",s.fillStyle="rgba(244,244,247,0.78)",s.shadowColor="rgba(0,0,0,0.90)",s.shadowBlur=6,s.textAlign="center",s.fillText(e.name,n,o+h+44),s.restore()}drawPing(e,t){const i=(t-e.t)/1e3;if(i>1.4)return;const s=this.ctx,n=8+i*40,o=(1-i/1.4)*.8;s.save();const a={error:`rgba(255,77,77,${o})`,spawn:`rgba(232,108,44,${o})`,select:`rgba(232,108,44,${o*.7})`};s.strokeStyle=a[e.kind]||a.spawn,s.lineWidth=e.kind==="select"?2:3,s.beginPath(),s.arc(e.x,e.y,n,0,Math.PI*2),s.stroke(),s.restore()}spawnSelectionPulses(e){const t=performance.now();for(const i of e)this.pings.push({x:i.x,y:i.y,kind:"select",t});for(;this.pings.length>48;)this.pings.shift()}drawMinimap(e){const t=this.mctx,i=this.minimapCanvas.getBoundingClientRect(),s=i.width,n=i.height;if(t.fillStyle="#070709",t.fillRect(0,0,s,n),this.texNoise){const p=t.createPattern(this.texNoise,"repeat");p&&(t.save(),t.globalAlpha=.2,t.fillStyle=p,t.fillRect(0,0,s,n),t.restore())}const o=s/this.world.w,a=n/this.world.h;for(const p of me){const f=p.bounds;t.save();const y=this.regionActivity.get(p.id)||0,g=y?Date.now()-y:999999,b=le(g/2e4,0,1);t.fillStyle=`rgba(0,0,0,${.28+b*.6})`,t.fillRect(f.x*o,f.y*a,f.width*o,f.height*a),t.strokeStyle="rgba(232,108,44,0.35)",t.lineWidth=1,t.strokeRect(f.x*o,f.y*a,f.width*o,f.height*a),t.restore()}if(this.cityManager)for(const p of this.cityManager.getAllBuildings()){const f=p.position.x*o,y=p.position.y*a,g=p.size.w*.4*o,b=p.size.h*.4*a,_=["rgba(191,87,0,0.7)","rgba(217,107,26,0.8)","rgba(255,107,53,0.9)"];t.fillStyle=_[p.tier-1]||_[0],t.fillRect(f-g/2,y-b/2,g,b)}for(const p of e.workers.values()){const f=p.position.x*o,y=p.position.y*a,g=p.status==="blocked"?"rgba(255,77,77,0.95)":p.status==="working"?"rgba(55,214,122,0.95)":p.status==="hold"?"rgba(247,201,72,0.95)":p.status==="moving"?"rgba(255,177,122,0.95)":"rgba(244,244,247,0.75)";t.fillStyle=g,t.fillRect(f-2,y-2,4,4)}const c=this.mapCanvas.getBoundingClientRect(),l=c.width/this.camera.zoom,h=c.height/this.camera.zoom,d=(this.camera.x-l/2)*o,u=(this.camera.y-h/2)*a;t.strokeStyle="rgba(244,244,247,0.65)",t.lineWidth=1,t.strokeRect(d,u,l*o,h*a)}minimapToWorld(e,t){const i=this.minimapCanvas.getBoundingClientRect(),s=(e-i.left)/i.width,n=(t-i.top)/i.height;return{x:le(s,0,1)*this.world.w,y:le(n,0,1)*this.world.h}}regionAt(e,t){return ri(e,t)}}const yi={spawn:"âš¡",task_start:"â›",task_complete:"âœ…",error:"â—",terminate:"âœ–",command:"âŒ˜",status:"â€¢"};function O(r){return document.getElementById(r)}class bi{constructor(e,t){this.state=e,this.renderer=t,this.$resCompleted=O("resCompleted"),this.$resFiles=O("resFiles"),this.$resWorkers=O("resWorkers"),this.$resFailed=O("resFailed"),this.$resDuration=O("resDuration"),this.$resTokens=O("resTokens"),this.$idleAlert=O("idleAlert"),this.$idleAlertCount=O("idleAlertCount"),this.$portraitIcon=O("portraitIcon"),this.$portraitName=O("portraitName"),this.$portraitTask=O("portraitTask"),this.$portraitMeter=O("portraitMeter"),this.$portraitStatus=O("portraitStatus"),this.$portraitElapsed=O("portraitElapsed"),this.$portraitTokens=O("portraitTokens"),this.$logFeed=O("logFeed"),this.$logStatus=O("logStatus"),this.$scoutReport=O("scoutReport"),this._idleIndex=0,this._lastLogRenderKey="",this.$idleAlert.addEventListener("click",()=>this.cycleIdle())}cycleIdle(){const e=this.state.getIdleOrBlocked();if(!e.length)return;this._idleIndex=(this._idleIndex+1)%e.length;const t=e[this._idleIndex];this.state.setSelected([t.id]),this.renderer.camera.x=t.position.x,this.renderer.camera.y=t.position.y}render(){const e=this.state;this.$resCompleted.textContent=String(e.stats.completed),this.$resFiles.textContent=String(e.stats.files),this.$resWorkers.textContent=String(e.workers.size),this.$resFailed.textContent=String(e.stats.failed),this.$resTokens.textContent=String(e.stats.tokens),this.$resDuration.textContent=bt(e.getSessionDurationMs());const t=e.getIdleOrBlocked();if(t.length){this.$idleAlert.hidden=!1,this.$idleAlertCount.textContent=String(t.length);const n=t.some(o=>o.status==="blocked");this.$idleAlert.classList.toggle("has-blocked",n)}else this.$idleAlert.hidden=!0;const i=e.getSelectedWorkers();if(i.length===1){const n=i[0];this.$portraitIcon.textContent=n.name.slice(0,1).toUpperCase(),this.$portraitName.textContent=n.name,this.$portraitTask.textContent=n.currentTask||"No current task.",this.$portraitStatus.textContent=n.status,this.$portraitElapsed.textContent=bt(Date.now()-n.spawnedAt),this.$portraitTokens.textContent=String(n.tokensUsed);const o=n.progress>=0&&n.progress<=100?n.progress:0;this.$portraitMeter.style.width=`${o}%`,this.$portraitMeter.className=`meter-fill status-${n.status}`}else i.length>1?(this.$portraitIcon.textContent=String(i.length),this.$portraitName.textContent=`${i.length} units selected`,this.$portraitTask.textContent="Multiple tasks.",this.$portraitStatus.textContent="-",this.$portraitElapsed.textContent="-",this.$portraitTokens.textContent="-",this.$portraitMeter.style.width="0%",this.$portraitMeter.className="meter-fill"):(this.$portraitIcon.textContent="?",this.$portraitName.textContent="No selection",this.$portraitTask.textContent="Select a worker on the map.",this.$portraitStatus.textContent="-",this.$portraitElapsed.textContent="-",this.$portraitTokens.textContent="-",this.$portraitMeter.style.width="0%",this.$portraitMeter.className="meter-fill");this.$scoutReport&&Array.isArray(e.scout)&&(this.$scoutReport.textContent="",e.scout.forEach((n,o)=>{const a=document.createElement("div");a.className=o===0?"scout-line":"scout-line muted",a.textContent=n,this.$scoutReport.appendChild(a)}));const s=`${e.events.length}:${e.selected.size}:${e.workers.size}:${e.stats.completed}:${e.stats.failed}`;s!==this._lastLogRenderKey&&(this._lastLogRenderKey=s,this.renderLog())}renderLog(){const e=this.state,i=e.events.slice(0,80);this.$logStatus.textContent=e.workers.size?"Live":"Idle",this.$logFeed.innerHTML=i.map(s=>{const n=yi[s.type]||"â€¢",o=new Date(s.timestamp),a=String(o.getHours()).padStart(2,"0"),c=String(o.getMinutes()).padStart(2,"0"),l=String(o.getSeconds()).padStart(2,"0"),h=`${a}:${c}:${l}`;return`<button class="log-item ${s.type==="error"?"err":s.type==="task_complete"?"ok":s.type==="spawn"?"spawn":""}" data-worker="${s.workerId}">
        <span class="log-time">${h}</span>
        <span class="log-ico">${n}</span>
        <span class="log-text">${wi(s.details)}</span>
      </button>`}).join(""),this.$logFeed.querySelectorAll("button.log-item").forEach(s=>{s.addEventListener("click",()=>{const n=s.getAttribute("data-worker");if(!n)return;const o=e.workers.get(n);o&&(e.setSelected([n]),this.renderer.camera.x=o.position.x,this.renderer.camera.y=o.position.y)})})}}function wi(r){return String(r).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}const wt=[{task:"Refactor component boundary",category:"production"},{task:"Wire endpoint to UI",category:"production"},{task:"Add keyboard shortcuts and focus states",category:"production"},{task:"Polish textures and gold frames",category:"production"},{task:"Build new feature module",category:"production"},{task:"Implement API integration",category:"production"},{task:"Investigate regression in renderer loop",category:"research"},{task:"Hunt down a flaky integration test",category:"research"},{task:"Analyze performance bottlenecks",category:"research"},{task:"Review architecture decisions",category:"research"},{task:"Fix failing unit tests",category:"repair"},{task:"Tighten types and remove implicit any",category:"repair"},{task:"Resolve merge conflicts",category:"repair"},{task:"Debug memory leak issue",category:"repair"},{task:"Extract state store and event bus",category:"storage"},{task:"Trim bundle and remove dead code",category:"storage"},{task:"Migrate data to new schema",category:"storage"},{task:"Archive deprecated modules",category:"storage"},{task:"Add security validation layer",category:"defense"},{task:"Monitor system metrics",category:"defense"},{task:"Set up alerting pipelines",category:"defense"},{task:"Coordinate deployment rollout",category:"command"},{task:"Orchestrate parallel builds",category:"command"}];function rt(r){return r[Math.floor(Math.random()*r.length)]}function _i(){return Math.random().toString(16).slice(2,10)}function W(){return Date.now()}function _t(){const r=[];for(const e of me){const t=e.type==="goldmine"?5:e.type==="lumber"?3:e.type==="townhall"?2:1;for(let i=0;i<t;i++)r.push(e)}return rt(r)}function Ke(r){return r.toLocaleString(void 0,{maximumFractionDigits:0})}class Ai{constructor(e){this.state=e,this.running=!1,this.timers=[],this.motion=new Map}manualAssign(e,t){for(const i of e){const s=this.state.workers.get(i);if(!s)continue;s.targetRegion=t.id,s.status="moving",s.progress=0,s.errorMessage=null,s.updatedAt=W();const n=ke(t);this.motion.set(s.id,{vx:0,vy:0,goal:n,speed:1.7+Math.random()*1.8}),this.state.upsertWorker({...s}),this.state.pushEvent({type:"command",workerId:s.id,details:`Assigned to ${t.name}.`,category:"command"})}}async connect(){this.running=!0,this.spawn(),this.spawn(),this.timers.push(setInterval(()=>this.maybeSpawn(),1600)),this.timers.push(setInterval(()=>this.step(),50)),this.timers.push(setInterval(()=>this.heartbeat(),1e3))}disconnect(){this.running=!1;for(const e of this.timers)clearInterval(e);this.timers=[]}maybeSpawn(){!this.running||this.state.workers.size>=10||Math.random()<.35&&this.spawn()}spawn(){const e=me.find(c=>c.id==="townhall")||me[0],t=ke(e),i=_t(),s=rt(wt),o={id:`w-${_i()}`,name:`Subagent-${Math.floor(1+Math.random()*99)}`,status:"moving",currentTask:s.task,taskCategory:s.category,targetRegion:i.id,position:{x:t.x,y:t.y},spawnedAt:W(),tokensUsed:Math.floor(200+Math.random()*800),progress:0,errorMessage:null,updatedAt:W()};this.state.upsertWorker(o),this.state.pushEvent({type:"spawn",workerId:o.id,details:`${o.name} rallied.`,category:"general"});const a=ke(i);this.motion.set(o.id,{vx:0,vy:0,goal:a,speed:1.6+Math.random()*1.6})}step(){if(this.running){for(const e of this.state.workers.values())if(e.status!=="terminated"){if(e.status==="moving"){const t=this.motion.get(e.id);if(!t)continue;const i=t.goal.x-e.position.x,s=t.goal.y-e.position.y,n=Math.hypot(i,s)||1,o=t.speed;e.position.x+=i/n*o,e.position.y+=s/n*o,e.updatedAt=W(),n<10&&(e.position.x=t.goal.x,e.position.y=t.goal.y,this.motion.delete(e.id),e.status=Math.random()<.12?"idle":"working",e.progress=e.status==="working"?Math.floor(5+Math.random()*14):0,e.updatedAt=W(),e.status==="working"?this.state.pushEvent({type:"task_start",workerId:e.id,details:`Started: ${e.currentTask}`,category:e.taskCategory||"production"}):this.state.pushEvent({type:"status",workerId:e.id,details:"Awaiting orders.",category:"general"})),this.state.upsertWorker({...e});continue}if(e.status==="hold"){e.tokensUsed+=1+Math.floor(Math.random()*3),e.updatedAt=W(),this.state.upsertWorker({...e});continue}if(e.status==="idle"){if(Math.random()<.03){const t=_t(),i=rt(wt);e.targetRegion=t.id,e.status="moving",e.currentTask=i.task,e.taskCategory=i.category,e.errorMessage=null,e.updatedAt=W(),this.motion.set(e.id,{vx:0,vy:0,goal:ke(t),speed:1.6+Math.random()*1.6}),this.state.pushEvent({type:"status",workerId:e.id,details:"Re-tasked.",category:"command"})}this.state.upsertWorker({...e});continue}if(e.status==="blocked"){Math.random()<.02&&(e.status="working",e.errorMessage=null,e.updatedAt=W(),this.state.pushEvent({type:"status",workerId:e.id,details:"Recovered; resumed.",category:"repair"})),this.state.upsertWorker({...e});continue}if(e.status==="working"){e.tokensUsed+=4+Math.floor(Math.random()*18);const t=.6+Math.random()*2.4;if(e.progress=le(e.progress+t,0,100),e.updatedAt=W(),Math.random()<.12&&this.state.bumpFiles(1),Math.random()<.006){e.status="blocked",e.errorMessage="Merge conflict in core module.",this.state.bumpFailed(1),this.state.pushEvent({type:"error",workerId:e.id,details:`Blocked: ${e.errorMessage}`,category:"repair"}),this.state.upsertWorker({...e});continue}e.progress>=100&&(e.status="complete",e.updatedAt=W(),this.state.bumpCompleted(1),this.state.pushEvent({type:"task_complete",workerId:e.id,details:`Completed: ${e.currentTask}`,category:e.taskCategory||"production"}),setTimeout(()=>{if(!this.running)return;const i=this.state.workers.get(e.id);i&&(i.status="terminated",i.updatedAt=W(),this.state.upsertWorker({...i}),this.state.pushEvent({type:"terminate",workerId:i.id,details:`${i.name} dismissed.`,category:"general"}),setTimeout(()=>this.state.removeWorker(i.id),900))},1400)),this.state.upsertWorker({...e});continue}e.status==="complete"&&this.state.upsertWorker({...e})}}}heartbeat(){this.state.tickStats();const e=this.state.getIdleOrBlocked().filter(n=>n.status==="idle").length,t=this.state.getIdleOrBlocked().filter(n=>n.status==="blocked").length,i=this.state.workers.size,s=t?`${Ke(t)} worker${t===1?"":"s"} blocked. Conflicts or missing info.`:e?`${Ke(e)} worker${e===1?"":"s"} idle. Assign tasks to keep momentum.`:`${Ke(i)} worker${i===1?"":"s"} executing cleanly.`;this.state.pushScoutLine(s)}}class Ti{constructor(e,t){this.state=e,this.bridge=t||{},this.assignMode=!1}exec(e){const t=this.state.getSelectedWorkers();if(t.length){if(e==="reassign"){this.assignMode=!0,this.state.pushEvent({type:"command",workerId:t[0].id,details:"Assign mode: right-click a region."}),this.state.pushScoutLine("Assign mode: right-click a region to send selected workers.");return}for(const i of t){if(e==="stop"&&(i.status="idle",i.progress=0,i.currentTask=i.currentTask,i.updatedAt=Date.now(),this.state.upsertWorker({...i}),this.state.pushEvent({type:"command",workerId:i.id,details:"Stopped."})),e==="hold"&&(i.status==="working"||i.status==="moving")&&(i.status="hold",i.updatedAt=Date.now(),this.state.upsertWorker({...i}),this.state.pushEvent({type:"command",workerId:i.id,details:"Held."})),e==="resume"&&(i.status==="hold"||i.status==="idle")&&(i.status="working",i.updatedAt=Date.now(),this.state.upsertWorker({...i}),this.state.pushEvent({type:"command",workerId:i.id,details:"Resumed."})),e==="inspect"){const s=i.errorMessage?`Inspect: ${i.errorMessage}`:`Inspect: ${i.currentTask||"No task"}`;this.state.pushEvent({type:"command",workerId:i.id,details:s}),this.state.pushScoutLine(s)}e==="terminate"&&(i.status="terminated",i.updatedAt=Date.now(),this.state.upsertWorker({...i}),this.state.pushEvent({type:"terminate",workerId:i.id,details:`${i.name} terminated.`}),setTimeout(()=>this.state.removeWorker(i.id),800))}}}assignSelectedTo(e){const t=this.state.getSelectedWorkers();if(!t.length)return;const i=t.map(s=>s.id);if(this.bridge.manualAssign)this.bridge.manualAssign(i,e);else{for(const s of t)s.targetRegion=e.id,s.status="moving",s.updatedAt=Date.now(),this.state.upsertWorker({...s});this.state.pushEvent({type:"command",workerId:t[0].id,details:`Assigned to ${e.name}.`})}this.assignMode=!1}}const At={type:"change"},dt={type:"start"},ss={type:"end"},Re=new ds,Tt=new us,Si=Math.cos(70*Ht.DEG2RAD),N=new F,G=2*Math.PI,R={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},Xe=1e-6;class Ei extends hs{constructor(e,t=null){super(e,t),this.state=R.NONE,this.enabled=!0,this.target=new F,this.cursor=new F,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ee.ROTATE,MIDDLE:ee.DOLLY,RIGHT:ee.PAN},this.touches={ONE:ne.ROTATE,TWO:ne.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new F,this._lastQuaternion=new Fe,this._lastTargetPosition=new F,this._quat=new Fe().setFromUnitVectors(e.up,new F(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new pt,this._sphericalDelta=new pt,this._scale=1,this._panOffset=new F,this._rotateStart=new H,this._rotateEnd=new H,this._rotateDelta=new H,this._panStart=new H,this._panEnd=new H,this._panDelta=new H,this._dollyStart=new H,this._dollyEnd=new H,this._dollyDelta=new H,this._dollyDirection=new F,this._mouse=new H,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=xi.bind(this),this._onPointerDown=vi.bind(this),this._onPointerUp=Mi.bind(this),this._onContextMenu=Di.bind(this),this._onMouseWheel=Li.bind(this),this._onKeyDown=Ii.bind(this),this._onTouchStart=Pi.bind(this),this._onTouchMove=Ci.bind(this),this._onMouseDown=ki.bind(this),this._onMouseMove=Ri.bind(this),this._interceptControlDown=Ni.bind(this),this._interceptControlUp=Oi.bind(this),this.domElement!==null&&this.connect(),this.update()}connect(){this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(At),this.update(),this.state=R.NONE}update(e=null){const t=this.object.position;N.copy(t).sub(this.target),N.applyQuaternion(this._quat),this._spherical.setFromVector3(N),this.autoRotate&&this.state===R.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let i=this.minAzimuthAngle,s=this.maxAzimuthAngle;isFinite(i)&&isFinite(s)&&(i<-Math.PI?i+=G:i>Math.PI&&(i-=G),s<-Math.PI?s+=G:s>Math.PI&&(s-=G),i<=s?this._spherical.theta=Math.max(i,Math.min(s,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(i+s)/2?Math.max(i,this._spherical.theta):Math.min(s,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let n=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const o=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),n=o!=this._spherical.radius}if(N.setFromSpherical(this._spherical),N.applyQuaternion(this._quatInverse),t.copy(this.target).add(N),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let o=null;if(this.object.isPerspectiveCamera){const a=N.length();o=this._clampDistance(a*this._scale);const c=a-o;this.object.position.addScaledVector(this._dollyDirection,c),this.object.updateMatrixWorld(),n=!!c}else if(this.object.isOrthographicCamera){const a=new F(this._mouse.x,this._mouse.y,0);a.unproject(this.object);const c=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),n=c!==this.object.zoom;const l=new F(this._mouse.x,this._mouse.y,0);l.unproject(this.object),this.object.position.sub(l).add(a),this.object.updateMatrixWorld(),o=N.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;o!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(o).add(this.object.position):(Re.origin.copy(this.object.position),Re.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(Re.direction))<Si?this.object.lookAt(this.target):(Tt.setFromNormalAndCoplanarPoint(this.object.up,this.target),Re.intersectPlane(Tt,this.target))))}else if(this.object.isOrthographicCamera){const o=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),o!==this.object.zoom&&(this.object.updateProjectionMatrix(),n=!0)}return this._scale=1,this._performCursorZoom=!1,n||this._lastPosition.distanceToSquared(this.object.position)>Xe||8*(1-this._lastQuaternion.dot(this.object.quaternion))>Xe||this._lastTargetPosition.distanceToSquared(this.target)>Xe?(this.dispatchEvent(At),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e!==null?G/60*this.autoRotateSpeed*e:G/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(e*.01);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){N.setFromMatrixColumn(t,0),N.multiplyScalar(-e),this._panOffset.add(N)}_panUp(e,t){this.screenSpacePanning===!0?N.setFromMatrixColumn(t,1):(N.setFromMatrixColumn(t,0),N.crossVectors(this.object.up,N)),N.multiplyScalar(e),this._panOffset.add(N)}_pan(e,t){const i=this.domElement;if(this.object.isPerspectiveCamera){const s=this.object.position;N.copy(s).sub(this.target);let n=N.length();n*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*n/i.clientHeight,this.object.matrix),this._panUp(2*t*n/i.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/i.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/i.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const i=this.domElement.getBoundingClientRect(),s=e-i.left,n=t-i.top,o=i.width,a=i.height;this._mouse.x=s/o*2-1,this._mouse.y=-(n/a)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(G*this._rotateDelta.x/t.clientHeight),this._rotateUp(G*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateUp(G*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateUp(-G*this.rotateSpeed/this.domElement.clientHeight):this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateLeft(G*this.rotateSpeed/this.domElement.clientHeight):this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this._rotateLeft(-G*this.rotateSpeed/this.domElement.clientHeight):this._pan(-this.keyPanSpeed,0),t=!0;break}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),i=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._rotateStart.set(i,s)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),i=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._panStart.set(i,s)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),i=e.pageX-t.x,s=e.pageY-t.y,n=Math.sqrt(i*i+s*s);this._dollyStart.set(0,n)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{const i=this._getSecondPointerPosition(e),s=.5*(e.pageX+i.x),n=.5*(e.pageY+i.y);this._rotateEnd.set(s,n)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(G*this._rotateDelta.x/t.clientHeight),this._rotateUp(G*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),i=.5*(e.pageX+t.x),s=.5*(e.pageY+t.y);this._panEnd.set(i,s)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),i=e.pageX-t.x,s=e.pageY-t.y,n=Math.sqrt(i*i+s*s);this._dollyEnd.set(0,n),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const o=(e.pageX+t.x)*.5,a=(e.pageY+t.y)*.5;this._updateZoomParameters(o,a)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId){this._pointers.splice(t,1);return}}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];t===void 0&&(t=new H,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,i={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:i.deltaY*=16;break;case 2:i.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(i.deltaY*=10),i}}function vi(r){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(r.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(r)&&(this._addPointer(r),r.pointerType==="touch"?this._onTouchStart(r):this._onMouseDown(r)))}function xi(r){this.enabled!==!1&&(r.pointerType==="touch"?this._onTouchMove(r):this._onMouseMove(r))}function Mi(r){switch(this._removePointer(r),this._pointers.length){case 0:this.domElement.releasePointerCapture(r.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(ss),this.state=R.NONE;break;case 1:const e=this._pointers[0],t=this._pointerPositions[e];this._onTouchStart({pointerId:e,pageX:t.x,pageY:t.y});break}}function ki(r){let e;switch(r.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case ee.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(r),this.state=R.DOLLY;break;case ee.ROTATE:if(r.ctrlKey||r.metaKey||r.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(r),this.state=R.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(r),this.state=R.ROTATE}break;case ee.PAN:if(r.ctrlKey||r.metaKey||r.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(r),this.state=R.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(r),this.state=R.PAN}break;default:this.state=R.NONE}this.state!==R.NONE&&this.dispatchEvent(dt)}function Ri(r){switch(this.state){case R.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(r);break;case R.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(r);break;case R.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(r);break}}function Li(r){this.enabled===!1||this.enableZoom===!1||this.state!==R.NONE||(r.preventDefault(),this.dispatchEvent(dt),this._handleMouseWheel(this._customWheelEvent(r)),this.dispatchEvent(ss))}function Ii(r){this.enabled===!1||this.enablePan===!1||this._handleKeyDown(r)}function Pi(r){switch(this._trackPointer(r),this._pointers.length){case 1:switch(this.touches.ONE){case ne.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(r),this.state=R.TOUCH_ROTATE;break;case ne.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(r),this.state=R.TOUCH_PAN;break;default:this.state=R.NONE}break;case 2:switch(this.touches.TWO){case ne.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(r),this.state=R.TOUCH_DOLLY_PAN;break;case ne.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(r),this.state=R.TOUCH_DOLLY_ROTATE;break;default:this.state=R.NONE}break;default:this.state=R.NONE}this.state!==R.NONE&&this.dispatchEvent(dt)}function Ci(r){switch(this._trackPointer(r),this.state){case R.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(r),this.update();break;case R.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(r),this.update();break;case R.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(r),this.update();break;case R.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(r),this.update();break;default:this.state=R.NONE}}function Di(r){this.enabled!==!1&&r.preventDefault()}function Ni(r){r.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function Oi(r){r.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}class Fi extends ps{constructor(e){super(e),this.type=xe}parse(e){const o=function(A,E){switch(A){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(E||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(E||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(E||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(E||""))}},d=function(A,E,x){E=E||1024;let P=A.pos,m=-1,w=0,M="",k=String.fromCharCode.apply(null,new Uint16Array(A.subarray(P,P+128)));for(;0>(m=k.indexOf(`
`))&&w<E&&P<A.byteLength;)M+=k,w+=k.length,P+=128,k+=String.fromCharCode.apply(null,new Uint16Array(A.subarray(P,P+128)));return-1<m?(A.pos+=w+m+1,M+k.slice(0,m)):!1},u=function(A){const E=/^#\?(\S+)/,x=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,I=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,P=/^\s*FORMAT=(\S+)\s*$/,m=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,w={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let M,k;for((A.pos>=A.byteLength||!(M=d(A)))&&o(1,"no header found"),(k=M.match(E))||o(3,"bad initial token"),w.valid|=1,w.programtype=k[1],w.string+=M+`
`;M=d(A),M!==!1;){if(w.string+=M+`
`,M.charAt(0)==="#"){w.comments+=M+`
`;continue}if((k=M.match(x))&&(w.gamma=parseFloat(k[1])),(k=M.match(I))&&(w.exposure=parseFloat(k[1])),(k=M.match(P))&&(w.valid|=2,w.format=k[1]),(k=M.match(m))&&(w.valid|=4,w.height=parseInt(k[1],10),w.width=parseInt(k[2],10)),w.valid&2&&w.valid&4)break}return w.valid&2||o(3,"missing format specifier"),w.valid&4||o(3,"missing image size specifier"),w},p=function(A,E,x){const I=E;if(I<8||I>32767||A[0]!==2||A[1]!==2||A[2]&128)return new Uint8Array(A);I!==(A[2]<<8|A[3])&&o(3,"wrong scanline width");const P=new Uint8Array(4*E*x);P.length||o(4,"unable to allocate buffer space");let m=0,w=0;const M=4*I,k=new Uint8Array(4),V=new Uint8Array(M);let fe=x;for(;fe>0&&w<A.byteLength;){w+4>A.byteLength&&o(1),k[0]=A[w++],k[1]=A[w++],k[2]=A[w++],k[3]=A[w++],(k[0]!=2||k[1]!=2||(k[2]<<8|k[3])!=I)&&o(3,"bad rgbe scanline format");let se=0,U;for(;se<M&&w<A.byteLength;){U=A[w++];const Z=U>128;if(Z&&(U-=128),(U===0||se+U>M)&&o(3,"bad scanline data"),Z){const Q=A[w++];for(let ut=0;ut<U;ut++)V[se++]=Q}else V.set(A.subarray(w,w+U),se),se+=U,w+=U}const ls=I;for(let Z=0;Z<ls;Z++){let Q=0;P[m]=V[Z+Q],Q+=I,P[m+1]=V[Z+Q],Q+=I,P[m+2]=V[Z+Q],Q+=I,P[m+3]=V[Z+Q],m+=4}fe--}return P},f=function(A,E,x,I){const P=A[E+3],m=Math.pow(2,P-128)/255;x[I+0]=A[E+0]*m,x[I+1]=A[E+1]*m,x[I+2]=A[E+2]*m,x[I+3]=1},y=function(A,E,x,I){const P=A[E+3],m=Math.pow(2,P-128)/255;x[I+0]=Me.toHalfFloat(Math.min(A[E+0]*m,65504)),x[I+1]=Me.toHalfFloat(Math.min(A[E+1]*m,65504)),x[I+2]=Me.toHalfFloat(Math.min(A[E+2]*m,65504)),x[I+3]=Me.toHalfFloat(1)},g=new Uint8Array(e);g.pos=0;const b=u(g),_=b.width,S=b.height,T=p(g.subarray(g.pos),_,S);let D,C,L;switch(this.type){case je:L=T.length/4;const A=new Float32Array(L*4);for(let x=0;x<L;x++)f(T,x*4,A,x*4);D=A,C=je;break;case xe:L=T.length/4;const E=new Uint16Array(L*4);for(let x=0;x<L;x++)y(T,x*4,E,x*4);D=E,C=xe;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:_,height:S,data:D,header:b.string,gamma:b.gamma,exposure:b.exposure,type:C}}setDataType(e){return this.type=e,this}load(e,t,i,s){function n(o,a){switch(o.type){case je:case xe:o.colorSpace=X,o.minFilter=de,o.magFilter=de,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,a)}return super.load(e,n,i,s)}}const Le="/assets/hdri",qe={day_warm:{path:`${Le}/day_warm.hdr`,exposure:1.2,ambientIntensity:.6,sunIntensity:1.2},day_bright:{path:`${Le}/day_bright.hdr`,exposure:1.4,ambientIntensity:.7,sunIntensity:1.4},night_clear:{path:`${Le}/night_clear.hdr`,exposure:.6,ambientIntensity:.2,sunIntensity:.3},night_starry:{path:`${Le}/night_starry.hdr`,exposure:.5,ambientIntensity:.15,sunIntensity:.2}};class Bi{constructor(e,t){this.scene=e,this.renderer=t,this.loader=new Fi,this.cache=new Map,this.currentPreset="day_warm",this.ambientLight=null,this.sunLight=null,this.findLights()}findLights(){this.scene.traverse(e=>{e instanceof $t&&(this.ambientLight=e),e instanceof _e&&e.castShadow&&(this.sunLight=e)})}async preload(){const e=Object.entries(qe).map(async([t,i])=>{try{const s=await this.loadHDRI(i.path);this.cache.set(t,s)}catch(s){console.warn(`Failed to load HDRI ${t}:`,s)}});await Promise.all(e)}loadHDRI(e){return new Promise((t,i)=>{this.loader.load(e,s=>{s.mapping=ms,t(s)},void 0,i)})}apply(e){const t=qe[e];if(!t){console.warn(`Unknown lighting preset: ${e}`);return}const i=this.cache.get(e);i&&(this.scene.environment=i,this.scene.background=i),this.renderer.toneMappingExposure=t.exposure,this.ambientLight&&(this.ambientLight.intensity=t.ambientIntensity),this.sunLight&&(this.sunLight.intensity=t.sunIntensity),this.currentPreset=e}getPresetForTime(e){return e>=6&&e<10?"day_warm":e>=10&&e<18?"day_bright":e>=18&&e<21?"day_warm":"night_clear"}updateForCurrentTime(){const e=new Date().getHours(),t=this.getPresetForTime(e);t!==this.currentPreset&&this.apply(t)}cyclePreset(){const e=Object.keys(qe),i=(e.indexOf(this.currentPreset)+1)%e.length;this.apply(e[i])}getCurrentPreset(){return this.currentPreset}dispose(){for(const e of this.cache.values())e.dispose();this.cache.clear()}}const ge="/assets/sprites",St={construction_sparks:{path:`${ge}/construction_sparks.png`,frames:16,cols:4,rows:4,frameTime:50,loop:!0},dust_cloud:{path:`${ge}/dust_cloud.png`,frames:16,cols:4,rows:4,frameTime:60,loop:!1},completion_burst:{path:`${ge}/completion_burst.png`,frames:16,cols:4,rows:4,frameTime:40,loop:!1},error_explosion:{path:`${ge}/error_explosion.png`,frames:16,cols:4,rows:4,frameTime:45,loop:!1},worker_teleport:{path:`${ge}/worker_teleport.png`,frames:16,cols:4,rows:4,frameTime:35,loop:!1}};class Gi{constructor(e){this.scene=e,this.textureLoader=new Ut,this.textures=new Map,this.activeEffects=[],this.loaded=!1}async preload(){const e=Object.entries(St).map(async([t,i])=>{try{const s=await this.loadTexture(i.path);s.wrapS=ve,s.wrapT=ve,s.repeat.set(1/i.cols,1/i.rows),s.magFilter=de,s.minFilter=de,this.textures.set(t,s)}catch(s){console.warn(`Failed to load sprite sheet ${t}:`,s)}});await Promise.all(e),this.loaded=!0}loadTexture(e){return new Promise((t,i)=>{this.textureLoader.load(e,t,void 0,i)})}play(e,t,i=1,s){if(!this.loaded)return;const n=St[e],o=this.textures.get(e);if(!n||!o){console.warn(`Unknown VFX effect: ${e}`);return}const a=o.clone();a.needsUpdate=!0;const c=new fs({map:a,transparent:!0,depthWrite:!1,blending:jt}),l=new gs(c);l.position.copy(t),l.scale.setScalar(i*2),this.scene.add(l);const h={sprite:l,config:n,currentFrame:0,elapsed:0,position:t.clone(),onComplete:s};this.activeEffects.push(h),this.updateSpriteFrame(h)}updateSpriteFrame(e){const{config:t,currentFrame:i,sprite:s}=e,n=i%t.cols,o=Math.floor(i/t.cols),a=s.material.map;a&&a.offset.set(n/t.cols,1-(o+1)/t.rows)}update(e){const t=e*1e3,i=[];for(const s of this.activeEffects)if(s.elapsed+=t,s.elapsed>=s.config.frameTime){if(s.elapsed=0,s.currentFrame++,s.currentFrame>=s.config.frames)if(s.config.loop)s.currentFrame=0;else{i.push(s);continue}this.updateSpriteFrame(s)}for(const s of i)this.removeEffect(s)}removeEffect(e){var i,s;this.scene.remove(e.sprite),(i=e.sprite.material.map)==null||i.dispose(),e.sprite.material.dispose();const t=this.activeEffects.indexOf(e);t!==-1&&this.activeEffects.splice(t,1),(s=e.onComplete)==null||s.call(e)}playConstructionSparks(e){this.play("construction_sparks",e,1.5)}playDustCloud(e){this.play("dust_cloud",e,2)}playCompletionBurst(e){this.play("completion_burst",e,2.5)}playErrorExplosion(e){this.play("error_explosion",e,2)}playWorkerTeleport(e){this.play("worker_teleport",e,1.5)}dispose(){var e;for(const t of this.activeEffects)this.scene.remove(t.sprite),(e=t.sprite.material.map)==null||e.dispose(),t.sprite.material.dispose();this.activeEffects.length=0;for(const t of this.textures.values())t.dispose();this.textures.clear()}}const Et=128,at=72,Ye=30*(Math.PI/180),vt=45*(Math.PI/180),Hi=.5,$i=2.5;function Ui(r){const e=new ys;e.background=new te(723727);const t=new bs(Et,at),i=new z({color:1710618,roughness:.9,metalness:.1}),s=new B(t,i);s.rotation.x=-Math.PI/2,s.position.y=0,s.receiveShadow=!0,s.name="ground",e.add(s);const n=new ws(Et,16,3355443,2236962);n.position.y=.01,n.name="grid",n.visible=!1,e.add(n);const o=r.width/r.height,a=at,c=new Wt(a*o/-2,a*o/2,a/2,a/-2,.1,1e3),l=100;c.position.set(Math.sin(vt)*Math.cos(Ye)*l,Math.sin(Ye)*l,Math.cos(vt)*Math.cos(Ye)*l),c.lookAt(0,0,0),c.zoom=1,c.updateProjectionMatrix();const h=new _s({canvas:r,antialias:!0,powerPreference:"high-performance"});h.setPixelRatio(Math.min(window.devicePixelRatio,2)),h.setSize(r.width,r.height),h.shadowMap.enabled=!0,h.shadowMap.type=As,h.toneMapping=Ts,h.toneMappingExposure=1.2;const d=new Ei(c,r);d.enableRotate=!1,d.enablePan=!0,d.enableZoom=!0,d.minZoom=Hi,d.maxZoom=$i,d.panSpeed=1.5,d.mouseButtons={LEFT:ee.PAN,MIDDLE:ee.DOLLY,RIGHT:ee.PAN},d.touches={ONE:ne.PAN,TWO:ne.DOLLY_PAN},Wi(e),e.fog=new Ss(723727,.008);const u=new Bi(e,h),p=new Gi(e);return{scene:e,camera:c,renderer:h,controls:d,lighting:u,vfx:p}}async function ji(r){try{await Promise.all([r.lighting.preload(),r.vfx.preload()]),r.lighting.apply("day_warm")}catch(e){console.warn("Failed to load enhancements:",e)}}function Wi(r){const e=new $t(4210768,.6);r.add(e);const t=new _e(16777215,1.2);t.position.set(50,80,30),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.shadow.camera.near=.1,t.shadow.camera.far=200,t.shadow.camera.left=-80,t.shadow.camera.right=80,t.shadow.camera.top=60,t.shadow.camera.bottom=-60,t.shadow.bias=-1e-4,r.add(t);const i=new _e(15232044,.3);i.position.set(-30,40,-20),r.add(i);const s=new _e(6324479,.15);s.position.set(0,20,-60),r.add(s);const n=new Es(8425632,1710618,.4);r.add(n)}function zi(r,e,t){const{camera:i,renderer:s}=r,n=e/t,o=at;i.left=o*n/-2,i.right=o*n/2,i.top=o/2,i.bottom=o/-2,i.updateProjectionMatrix(),s.setSize(e,t)}function Ki(r){const e=r.getObjectByName("grid");e&&(e.visible=!e.visible)}function Xi(r,e){const{scene:t,camera:i,renderer:s,controls:n,vfx:o}=r,a=new vs;let c=!0;function l(){if(!c)return;requestAnimationFrame(l);const h=a.getDelta();e(h),o.update(h),n.update(),s.render(t,i)}return l(),()=>{c=!1}}const Ie="/assets/ui/portraits",xt={idle:{image:`${Ie}/blaze_idle.png`,alt:"Blaze - Idle"},working:{image:`${Ie}/blaze_working.png`,alt:"Blaze - Working"},error:{image:`${Ie}/blaze_error.png`,alt:"Blaze - Error"},complete:{image:`${Ie}/blaze_complete.png`,alt:"Blaze - Complete"}};class Mt{constructor(e){this.container=e,this.currentState="idle",this.imageElement=null,this.completeTimeout=0,this.init()}init(){const e=this.container.querySelector(".portrait-frame");if(!e)return;this.imageElement=document.createElement("img"),this.imageElement.className="portrait-mascot",this.imageElement.width=80,this.imageElement.height=80,this.imageElement.alt="Blaze mascot";const t=e.querySelector(".portrait-icon");t&&(t.style.display="none"),e.appendChild(this.imageElement),this.setState("idle")}setState(e){if(this.currentState===e)return;const t=xt[e];!t||!this.imageElement||(this.currentState=e,this.imageElement.src=t.image,this.imageElement.alt=t.alt,this.container.dataset.mascotState=e,this.completeTimeout&&(clearTimeout(this.completeTimeout),this.completeTimeout=0))}updateFromWorkerStatus(e){if(!e){this.setState("idle");return}switch(e){case"idle":case"hold":this.setState("idle");break;case"working":case"moving":this.setState("working");break;case"blocked":case"terminated":this.setState("error");break;case"complete":this.showCompletion();break;default:this.setState("idle")}}showCompletion(){this.setState("complete"),this.completeTimeout=window.setTimeout(()=>{this.setState("idle"),this.completeTimeout=0},3e3)}showError(){this.setState("error"),this.completeTimeout&&clearTimeout(this.completeTimeout),this.completeTimeout=window.setTimeout(()=>{this.setState("idle"),this.completeTimeout=0},2e3)}updateFromWorkers(e){if(e.length===0){this.setState("idle");return}const t=e.some(n=>n.status==="blocked"||n.status==="terminated"),i=e.some(n=>n.status==="working"||n.status==="moving"),s=e.some(n=>n.status==="complete");t?this.setState("error"):i?this.setState("working"):s?this.showCompletion():this.setState("idle")}getState(){return this.currentState}static async preloadImages(){const e=Object.values(xt).map(t=>new Promise(i=>{const s=new Image;s.onload=i,s.onerror=i,s.src=t.image}));await Promise.all(e)}dispose(){this.completeTimeout&&clearTimeout(this.completeTimeout),this.imageElement&&this.imageElement.parentNode&&this.imageElement.parentNode.removeChild(this.imageElement)}}function kt(r,e){if(e===xs)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),r;if(e===nt||e===zt){let t=r.getIndex();if(t===null){const o=[],a=r.getAttribute("position");if(a!==void 0){for(let c=0;c<a.count;c++)o.push(c);r.setIndex(o),t=r.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),r}const i=t.count-2,s=[];if(e===nt)for(let o=1;o<=i;o++)s.push(t.getX(0)),s.push(t.getX(o)),s.push(t.getX(o+1));else for(let o=0;o<i;o++)o%2===0?(s.push(t.getX(o)),s.push(t.getX(o+1)),s.push(t.getX(o+2))):(s.push(t.getX(o+2)),s.push(t.getX(o+1)),s.push(t.getX(o)));s.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=r.clone();return n.setIndex(s),n.clearGroups(),n}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),r}class qi extends Kt{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Ji(t)}),this.register(function(t){return new en(t)}),this.register(function(t){return new hn(t)}),this.register(function(t){return new dn(t)}),this.register(function(t){return new un(t)}),this.register(function(t){return new sn(t)}),this.register(function(t){return new nn(t)}),this.register(function(t){return new on(t)}),this.register(function(t){return new rn(t)}),this.register(function(t){return new Qi(t)}),this.register(function(t){return new an(t)}),this.register(function(t){return new tn(t)}),this.register(function(t){return new ln(t)}),this.register(function(t){return new cn(t)}),this.register(function(t){return new Vi(t)}),this.register(function(t){return new pn(t)}),this.register(function(t){return new mn(t)})}load(e,t,i,s){const n=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const l=Ae.extractUrlBase(e);o=Ae.resolveURL(l,this.path)}else o=Ae.extractUrlBase(e);this.manager.itemStart(e);const a=function(l){s?s(l):console.error(l),n.manager.itemError(e),n.manager.itemEnd(e)},c=new Be(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(e,function(l){try{n.parse(l,o,function(h){t(h),n.manager.itemEnd(e)},a)}catch(h){a(h)}},i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let n;const o={},a={},c=new TextDecoder;if(typeof e=="string")n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(c.decode(new Uint8Array(e,0,4))===is){try{o[v.KHR_BINARY_GLTF]=new fn(e)}catch(d){s&&s(d);return}n=JSON.parse(o[v.KHR_BINARY_GLTF].content)}else n=JSON.parse(c.decode(e));else n=e;if(n.asset===void 0||n.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new kn(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const d=this.pluginCallbacks[h](l);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[d.name]=d,o[d.name]=!0}if(n.extensionsUsed)for(let h=0;h<n.extensionsUsed.length;++h){const d=n.extensionsUsed[h],u=n.extensionsRequired||[];switch(d){case v.KHR_MATERIALS_UNLIT:o[d]=new Zi;break;case v.KHR_DRACO_MESH_COMPRESSION:o[d]=new gn(n,this.dracoLoader);break;case v.KHR_TEXTURE_TRANSFORM:o[d]=new yn;break;case v.KHR_MESH_QUANTIZATION:o[d]=new bn;break;default:u.indexOf(d)>=0&&a[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}l.setExtensions(o),l.setPlugins(a),l.parse(i,s)}parseAsync(e,t){const i=this;return new Promise(function(s,n){i.parse(e,t,s,n)})}}function Yi(){let r={};return{get:function(e){return r[e]},add:function(e,t){r[e]=t},remove:function(e){delete r[e]},removeAll:function(){r={}}}}const v={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Vi{constructor(e){this.parser=e,this.name=v.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,s=t.length;i<s;i++){const n=t[i];n.extensions&&n.extensions[this.name]&&n.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let s=t.cache.get(i);if(s)return s;const n=t.json,c=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let l;const h=new te(16777215);c.color!==void 0&&h.setRGB(c.color[0],c.color[1],c.color[2],X);const d=c.range!==void 0?c.range:0;switch(c.type){case"directional":l=new _e(h),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new ks(h),l.distance=d;break;case"spot":l=new Ms(h),l.distance=d,c.spot=c.spot||{},c.spot.innerConeAngle=c.spot.innerConeAngle!==void 0?c.spot.innerConeAngle:0,c.spot.outerConeAngle=c.spot.outerConeAngle!==void 0?c.spot.outerConeAngle:Math.PI/4,l.angle=c.spot.outerConeAngle,l.penumbra=1-c.spot.innerConeAngle/c.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+c.type)}return l.position.set(0,0,0),l.decay=2,J(l,c),c.intensity!==void 0&&(l.intensity=c.intensity),l.name=t.createUniqueName(c.name||"light_"+e),s=Promise.resolve(l),t.cache.add(i,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,n=i.json.nodes[e],a=(n.extensions&&n.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(c){return i._getNodeRef(t.cache,a,c)})}}class Zi{constructor(){this.name=v.KHR_MATERIALS_UNLIT}getMaterialType(){return K}extendParams(e,t,i){const s=[];e.color=new te(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const o=n.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],X),e.opacity=o[3]}n.baseColorTexture!==void 0&&s.push(i.assignTexture(e,"map",n.baseColorTexture,oe))}return Promise.all(s)}}class Qi{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return n!==void 0&&(t.emissiveIntensity=n),Promise.resolve()}}class Ji{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],o=s.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&n.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&n.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(n.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new H(a,a)}return Promise.all(n)}}class en{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_DISPERSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.dispersion=n.dispersion!==void 0?n.dispersion:0,Promise.resolve()}}class tn{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],o=s.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&n.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&n.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(n)}}class sn{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_SHEEN}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new te(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=s.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],X)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&n.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,oe)),o.sheenRoughnessTexture!==void 0&&n.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(n)}}class nn{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],o=s.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&n.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(n)}}class on{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_VOLUME}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],o=s.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&n.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new te().setRGB(a[0],a[1],a[2],X),Promise.all(n)}}class rn{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_IOR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=n.ior!==void 0?n.ior:1.5,Promise.resolve()}}class an{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_SPECULAR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],o=s.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&n.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new te().setRGB(a[0],a[1],a[2],X),o.specularColorTexture!==void 0&&n.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,oe)),Promise.all(n)}}class cn{constructor(e){this.parser=e,this.name=v.EXT_MATERIALS_BUMP}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],o=s.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&n.push(i.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(n)}}class ln{constructor(e){this.parser=e,this.name=v.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:Y}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],o=s.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&n.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(n)}}class hn{constructor(e){this.parser=e,this.name=v.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,s=i.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const n=s.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,o)}}class dn{constructor(e){this.parser=e,this.name=v.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,s=i.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const o=n.extensions[t],a=s.images[o.source];let c=i.textureLoader;if(a.uri){const l=i.options.manager.getHandler(a.uri);l!==null&&(c=l)}return this.detectSupport().then(function(l){if(l)return i.loadTextureImage(e,o.source,c);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class un{constructor(e){this.parser=e,this.name=v.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,s=i.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const o=n.extensions[t],a=s.images[o.source];let c=i.textureLoader;if(a.uri){const l=i.options.manager.getHandler(a.uri);l!==null&&(c=l)}return this.detectSupport().then(function(l){if(l)return i.loadTextureImage(e,o.source,c);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class pn{constructor(e){this.name=v.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const s=i.extensions[this.name],n=this.parser.getDependency("buffer",s.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(a){const c=s.byteOffset||0,l=s.byteLength||0,h=s.count,d=s.byteStride,u=new Uint8Array(a,c,l);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(h,d,u,s.mode,s.filter).then(function(p){return p.buffer}):o.ready.then(function(){const p=new ArrayBuffer(h*d);return o.decodeGltfBuffer(new Uint8Array(p),h,d,u,s.mode,s.filter),p})})}else return null}}class mn{constructor(e){this.name=v.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const s=t.meshes[i.mesh];for(const l of s.primitives)if(l.mode!==j.TRIANGLES&&l.mode!==j.TRIANGLE_STRIP&&l.mode!==j.TRIANGLE_FAN&&l.mode!==void 0)return null;const o=i.extensions[this.name].attributes,a=[],c={};for(const l in o)a.push(this.parser.getDependency("accessor",o[l]).then(h=>(c[l]=h,c[l])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(l=>{const h=l.pop(),d=h.isGroup?h.children:[h],u=l[0].count,p=[];for(const f of d){const y=new Ge,g=new F,b=new Fe,_=new F(1,1,1),S=new Rs(f.geometry,f.material,u);for(let T=0;T<u;T++)c.TRANSLATION&&g.fromBufferAttribute(c.TRANSLATION,T),c.ROTATION&&b.fromBufferAttribute(c.ROTATION,T),c.SCALE&&_.fromBufferAttribute(c.SCALE,T),S.setMatrixAt(T,y.compose(g,b,_));for(const T in c)if(T==="_COLOR_0"){const D=c[T];S.instanceColor=new Ls(D.array,D.itemSize,D.normalized)}else T!=="TRANSLATION"&&T!=="ROTATION"&&T!=="SCALE"&&f.geometry.setAttribute(T,c[T]);Xt.prototype.copy.call(S,f),this.parser.assignFinalMaterial(S),p.push(S)}return h.isGroup?(h.clear(),h.add(...p),h):p[0]}))}}const is="glTF",ye=12,Rt={JSON:1313821514,BIN:5130562};class fn{constructor(e){this.name=v.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,ye),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==is)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-ye,n=new DataView(e,ye);let o=0;for(;o<s;){const a=n.getUint32(o,!0);o+=4;const c=n.getUint32(o,!0);if(o+=4,c===Rt.JSON){const l=new Uint8Array(e,ye+o,a);this.content=i.decode(l)}else if(c===Rt.BIN){const l=ye+o;this.body=e.slice(l,l+a)}o+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class gn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=v.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,s=this.dracoLoader,n=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},c={},l={};for(const h in o){const d=ct[h]||h.toLowerCase();a[d]=o[h]}for(const h in e.attributes){const d=ct[h]||h.toLowerCase();if(o[h]!==void 0){const u=i.accessors[e.attributes[h]],p=pe[u.componentType];l[d]=p.name,c[d]=u.normalized===!0}}return t.getDependency("bufferView",n).then(function(h){return new Promise(function(d,u){s.decodeDracoFile(h,function(p){for(const f in p.attributes){const y=p.attributes[f],g=c[f];g!==void 0&&(y.normalized=g)}d(p)},a,l,X,u)})})}}class yn{constructor(){this.name=v.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class bn{constructor(){this.name=v.KHR_MESH_QUANTIZATION}}class ns extends Zs{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=e*s*3+s;for(let o=0;o!==s;o++)t[o]=i[n+o];return t}interpolate_(e,t,i,s){const n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,c=a*2,l=a*3,h=s-t,d=(i-t)/h,u=d*d,p=u*d,f=e*l,y=f-l,g=-2*p+3*u,b=p-u,_=1-g,S=b-u+d;for(let T=0;T!==a;T++){const D=o[y+T+a],C=o[y+T+c]*h,L=o[f+T+a],A=o[f+T]*h;n[T]=_*D+S*C+g*L+b*A}return n}}const wn=new Fe;class _n extends ns{interpolate_(e,t,i,s){const n=super.interpolate_(e,t,i,s);return wn.fromArray(n).normalize().toArray(n),n}}const j={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},pe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Lt={9728:Yt,9729:de,9984:Ns,9985:Ds,9986:Cs,9987:qt},It={33071:Fs,33648:Os,10497:ve},Ve={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ct={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ie={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},An={CUBICSPLINE:void 0,LINEAR:Qt,STEP:qs},Ze={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Tn(r){return r.DefaultMaterial===void 0&&(r.DefaultMaterial=new z({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Vs})),r.DefaultMaterial}function re(r,e,t){for(const i in t.extensions)r[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function J(r,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(r.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Sn(r,e,t){let i=!1,s=!1,n=!1;for(let l=0,h=e.length;l<h;l++){const d=e[l];if(d.POSITION!==void 0&&(i=!0),d.NORMAL!==void 0&&(s=!0),d.COLOR_0!==void 0&&(n=!0),i&&s&&n)break}if(!i&&!s&&!n)return Promise.resolve(r);const o=[],a=[],c=[];for(let l=0,h=e.length;l<h;l++){const d=e[l];if(i){const u=d.POSITION!==void 0?t.getDependency("accessor",d.POSITION):r.attributes.position;o.push(u)}if(s){const u=d.NORMAL!==void 0?t.getDependency("accessor",d.NORMAL):r.attributes.normal;a.push(u)}if(n){const u=d.COLOR_0!==void 0?t.getDependency("accessor",d.COLOR_0):r.attributes.color;c.push(u)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(c)]).then(function(l){const h=l[0],d=l[1],u=l[2];return i&&(r.morphAttributes.position=h),s&&(r.morphAttributes.normal=d),n&&(r.morphAttributes.color=u),r.morphTargetsRelative=!0,r})}function En(r,e){if(r.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)r.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(r.morphTargetInfluences.length===t.length){r.morphTargetDictionary={};for(let i=0,s=t.length;i<s;i++)r.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function vn(r){let e;const t=r.extensions&&r.extensions[v.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+Qe(t.attributes):e=r.indices+":"+Qe(r.attributes)+":"+r.mode,r.targets!==void 0)for(let i=0,s=r.targets.length;i<s;i++)e+=":"+Qe(r.targets[i]);return e}function Qe(r){let e="";const t=Object.keys(r).sort();for(let i=0,s=t.length;i<s;i++)e+=t[i]+":"+r[t[i]]+";";return e}function lt(r){switch(r){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function xn(r){return r.search(/\.jpe?g($|\?)/i)>0||r.search(/^data\:image\/jpeg/)===0?"image/jpeg":r.search(/\.webp($|\?)/i)>0||r.search(/^data\:image\/webp/)===0?"image/webp":r.search(/\.ktx2($|\?)/i)>0||r.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Mn=new Ge;class kn{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Yi,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,s=-1,n=!1,o=-1;if(typeof navigator<"u"){const a=navigator.userAgent;i=/^((?!chrome|android).)*safari/i.test(a)===!0;const c=a.match(/Version\/(\d+)/);s=i&&c?parseInt(c[1],10):-1,n=a.indexOf("Firefox")>-1,o=n?a.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||i&&s<17||n&&o<98?this.textureLoader=new Ut(this.options.manager):this.textureLoader=new Is(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Be(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,s=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(o){const a={scene:o[0][s.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:s.asset,parser:i,userData:{}};return re(n,a,s),J(a,s),Promise.all(i._invokeAll(function(c){return c.afterRoot&&c.afterRoot(a)})).then(function(){for(const c of a.scenes)c.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let s=0,n=t.length;s<n;s++){const o=t[s].joints;for(let a=0,c=o.length;a<c;a++)e[o[a]].isBone=!0}for(let s=0,n=e.length;s<n;s++){const o=e[s];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(i[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const s=i.clone(),n=(o,a)=>{const c=this.associations.get(o);c!=null&&this.associations.set(a,c);for(const[l,h]of o.children.entries())n(h,a.children[l])};return n(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let s=0;s<t.length;s++){const n=e(t[s]);n&&i.push(n)}return i}getDependency(e,t){const i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(n){return n.loadNode&&n.loadNode(t)});break;case"mesh":s=this._invokeOne(function(n){return n.loadMesh&&n.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(n){return n.loadBufferView&&n.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(n){return n.loadMaterial&&n.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(n){return n.loadTexture&&n.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(n){return n.loadAnimation&&n.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(i,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(n,o){return i.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[v.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(n,o){i.load(Ae.resolveURL(t.uri,s.path),n,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const s=t.byteLength||0,n=t.byteOffset||0;return i.slice(n,n+s)})}loadAccessor(e){const t=this,i=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const o=Ve[s.type],a=pe[s.componentType],c=s.normalized===!0,l=new a(s.count*o);return Promise.resolve(new Te(l,o,c))}const n=[];return s.bufferView!==void 0?n.push(this.getDependency("bufferView",s.bufferView)):n.push(null),s.sparse!==void 0&&(n.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(n).then(function(o){const a=o[0],c=Ve[s.type],l=pe[s.componentType],h=l.BYTES_PER_ELEMENT,d=h*c,u=s.byteOffset||0,p=s.bufferView!==void 0?i.bufferViews[s.bufferView].byteStride:void 0,f=s.normalized===!0;let y,g;if(p&&p!==d){const b=Math.floor(u/p),_="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+b+":"+s.count;let S=t.cache.get(_);S||(y=new l(a,b*p,s.count*p/h),S=new Ps(y,p/h),t.cache.add(_,S)),g=new Ys(S,c,u%p/h,f)}else a===null?y=new l(s.count*c):y=new l(a,u,s.count*c),g=new Te(y,c,f);if(s.sparse!==void 0){const b=Ve.SCALAR,_=pe[s.sparse.indices.componentType],S=s.sparse.indices.byteOffset||0,T=s.sparse.values.byteOffset||0,D=new _(o[1],S,s.sparse.count*b),C=new l(o[2],T,s.sparse.count*c);a!==null&&(g=new Te(g.array.slice(),g.itemSize,g.normalized)),g.normalized=!1;for(let L=0,A=D.length;L<A;L++){const E=D[L];if(g.setX(E,C[L*c]),c>=2&&g.setY(E,C[L*c+1]),c>=3&&g.setZ(E,C[L*c+2]),c>=4&&g.setW(E,C[L*c+3]),c>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}g.normalized=f}return g})}loadTexture(e){const t=this.json,i=this.options,n=t.textures[e].source,o=t.images[n];let a=this.textureLoader;if(o.uri){const c=i.manager.getHandler(o.uri);c!==null&&(a=c)}return this.loadTextureImage(e,n,a)}loadTextureImage(e,t,i){const s=this,n=this.json,o=n.textures[e],a=n.images[t],c=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[c])return this.textureCache[c];const l=this.loadImageSource(t,i).then(function(h){h.flipY=!1,h.name=o.name||a.name||"",h.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(h.name=a.uri);const u=(n.samplers||{})[o.sampler]||{};return h.magFilter=Lt[u.magFilter]||de,h.minFilter=Lt[u.minFilter]||qt,h.wrapS=It[u.wrapS]||ve,h.wrapT=It[u.wrapT]||ve,h.generateMipmaps=!h.isCompressedTexture&&h.minFilter!==Yt&&h.minFilter!==de,s.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[c]=l,l}loadImageSource(e,t){const i=this,s=this.json,n=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(d=>d.clone());const o=s.images[e],a=self.URL||self.webkitURL;let c=o.uri||"",l=!1;if(o.bufferView!==void 0)c=i.getDependency("bufferView",o.bufferView).then(function(d){l=!0;const u=new Blob([d],{type:o.mimeType});return c=a.createObjectURL(u),c});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(c).then(function(d){return new Promise(function(u,p){let f=u;t.isImageBitmapLoader===!0&&(f=function(y){const g=new mt(y);g.needsUpdate=!0,u(g)}),t.load(Ae.resolveURL(d,n.path),f,void 0,p)})}).then(function(d){return l===!0&&a.revokeObjectURL(c),J(d,o),d.userData.mimeType=o.mimeType||xn(o.uri),d}).catch(function(d){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),d});return this.sourceCache[e]=h,h}assignTexture(e,t,i,s){const n=this;return this.getDependency("texture",i.index).then(function(o){if(!o)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(o=o.clone(),o.channel=i.texCoord),n.extensions[v.KHR_TEXTURE_TRANSFORM]){const a=i.extensions!==void 0?i.extensions[v.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const c=n.associations.get(o);o=n.extensions[v.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),n.associations.set(o,c)}}return s!==void 0&&(o.colorSpace=s),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const s=t.attributes.tangent===void 0,n=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+i.uuid;let c=this.cache.get(a);c||(c=new Vt,Oe.prototype.copy.call(c,i),c.color.copy(i.color),c.map=i.map,c.sizeAttenuation=!1,this.cache.add(a,c)),i=c}else if(e.isLine){const a="LineBasicMaterial:"+i.uuid;let c=this.cache.get(a);c||(c=new Bs,Oe.prototype.copy.call(c,i),c.color.copy(i.color),c.map=i.map,this.cache.add(a,c)),i=c}if(s||n||o){let a="ClonedMaterial:"+i.uuid+":";s&&(a+="derivative-tangents:"),n&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let c=this.cache.get(a);c||(c=i.clone(),n&&(c.vertexColors=!0),o&&(c.flatShading=!0),s&&(c.normalScale&&(c.normalScale.y*=-1),c.clearcoatNormalScale&&(c.clearcoatNormalScale.y*=-1)),this.cache.add(a,c),this.associations.set(c,this.associations.get(i))),i=c}e.material=i}getMaterialType(){return z}loadMaterial(e){const t=this,i=this.json,s=this.extensions,n=i.materials[e];let o;const a={},c=n.extensions||{},l=[];if(c[v.KHR_MATERIALS_UNLIT]){const d=s[v.KHR_MATERIALS_UNLIT];o=d.getMaterialType(),l.push(d.extendParams(a,n,t))}else{const d=n.pbrMetallicRoughness||{};if(a.color=new te(1,1,1),a.opacity=1,Array.isArray(d.baseColorFactor)){const u=d.baseColorFactor;a.color.setRGB(u[0],u[1],u[2],X),a.opacity=u[3]}d.baseColorTexture!==void 0&&l.push(t.assignTexture(a,"map",d.baseColorTexture,oe)),a.metalness=d.metallicFactor!==void 0?d.metallicFactor:1,a.roughness=d.roughnessFactor!==void 0?d.roughnessFactor:1,d.metallicRoughnessTexture!==void 0&&(l.push(t.assignTexture(a,"metalnessMap",d.metallicRoughnessTexture)),l.push(t.assignTexture(a,"roughnessMap",d.metallicRoughnessTexture))),o=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(e,a)})))}n.doubleSided===!0&&(a.side=He);const h=n.alphaMode||Ze.OPAQUE;if(h===Ze.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,h===Ze.MASK&&(a.alphaTest=n.alphaCutoff!==void 0?n.alphaCutoff:.5)),n.normalTexture!==void 0&&o!==K&&(l.push(t.assignTexture(a,"normalMap",n.normalTexture)),a.normalScale=new H(1,1),n.normalTexture.scale!==void 0)){const d=n.normalTexture.scale;a.normalScale.set(d,d)}if(n.occlusionTexture!==void 0&&o!==K&&(l.push(t.assignTexture(a,"aoMap",n.occlusionTexture)),n.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=n.occlusionTexture.strength)),n.emissiveFactor!==void 0&&o!==K){const d=n.emissiveFactor;a.emissive=new te().setRGB(d[0],d[1],d[2],X)}return n.emissiveTexture!==void 0&&o!==K&&l.push(t.assignTexture(a,"emissiveMap",n.emissiveTexture,oe)),Promise.all(l).then(function(){const d=new o(a);return n.name&&(d.name=n.name),J(d,n),t.associations.set(d,{materials:e}),n.extensions&&re(s,d,n),d})}createUniqueName(e){const t=Gs.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,s=this.primitiveCache;function n(a){return i[v.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(c){return Pt(c,a,t)})}const o=[];for(let a=0,c=e.length;a<c;a++){const l=e[a],h=vn(l),d=s[h];if(d)o.push(d.promise);else{let u;l.extensions&&l.extensions[v.KHR_DRACO_MESH_COMPRESSION]?u=n(l):u=Pt(new ht,l,t),s[h]={primitive:l,promise:u},o.push(u)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,s=this.extensions,n=i.meshes[e],o=n.primitives,a=[];for(let c=0,l=o.length;c<l;c++){const h=o[c].material===void 0?Tn(this.cache):this.getDependency("material",o[c].material);a.push(h)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(c){const l=c.slice(0,c.length-1),h=c[c.length-1],d=[];for(let p=0,f=h.length;p<f;p++){const y=h[p],g=o[p];let b;const _=l[p];if(g.mode===j.TRIANGLES||g.mode===j.TRIANGLE_STRIP||g.mode===j.TRIANGLE_FAN||g.mode===void 0)b=n.isSkinnedMesh===!0?new Hs(y,_):new B(y,_),b.isSkinnedMesh===!0&&b.normalizeSkinWeights(),g.mode===j.TRIANGLE_STRIP?b.geometry=kt(b.geometry,zt):g.mode===j.TRIANGLE_FAN&&(b.geometry=kt(b.geometry,nt));else if(g.mode===j.LINES)b=new $s(y,_);else if(g.mode===j.LINE_STRIP)b=new Us(y,_);else if(g.mode===j.LINE_LOOP)b=new js(y,_);else if(g.mode===j.POINTS)b=new Zt(y,_);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);Object.keys(b.geometry.morphAttributes).length>0&&En(b,n),b.name=t.createUniqueName(n.name||"mesh_"+e),J(b,n),g.extensions&&re(s,b,g),t.assignFinalMaterial(b),d.push(b)}for(let p=0,f=d.length;p<f;p++)t.associations.set(d[p],{meshes:e,primitives:p});if(d.length===1)return n.extensions&&re(s,d[0],n),d[0];const u=new Se;n.extensions&&re(s,u,n),t.associations.set(u,{meshes:e});for(let p=0,f=d.length;p<f;p++)u.add(d[p]);return u})}loadCamera(e){let t;const i=this.json.cameras[e],s=i[i.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new Ws(Ht.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):i.type==="orthographic"&&(t=new Wt(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),J(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let s=0,n=t.joints.length;s<n;s++)i.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(s){const n=s.pop(),o=s,a=[],c=[];for(let l=0,h=o.length;l<h;l++){const d=o[l];if(d){a.push(d);const u=new Ge;n!==null&&u.fromArray(n.array,l*16),c.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[l])}return new zs(a,c)})}loadAnimation(e){const t=this.json,i=this,s=t.animations[e],n=s.name?s.name:"animation_"+e,o=[],a=[],c=[],l=[],h=[];for(let d=0,u=s.channels.length;d<u;d++){const p=s.channels[d],f=s.samplers[p.sampler],y=p.target,g=y.node,b=s.parameters!==void 0?s.parameters[f.input]:f.input,_=s.parameters!==void 0?s.parameters[f.output]:f.output;y.node!==void 0&&(o.push(this.getDependency("node",g)),a.push(this.getDependency("accessor",b)),c.push(this.getDependency("accessor",_)),l.push(f),h.push(y))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(c),Promise.all(l),Promise.all(h)]).then(function(d){const u=d[0],p=d[1],f=d[2],y=d[3],g=d[4],b=[];for(let _=0,S=u.length;_<S;_++){const T=u[_],D=p[_],C=f[_],L=y[_],A=g[_];if(T===void 0)continue;T.updateMatrix&&T.updateMatrix();const E=i._createAnimationTracks(T,D,C,L,A);if(E)for(let x=0;x<E.length;x++)b.push(E[x])}return new Ks(n,void 0,b)})}createNodeMesh(e){const t=this.json,i=this,s=t.nodes[e];return s.mesh===void 0?null:i.getDependency("mesh",s.mesh).then(function(n){const o=i._getNodeRef(i.meshCache,s.mesh,n);return s.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let c=0,l=s.weights.length;c<l;c++)a.morphTargetInfluences[c]=s.weights[c]}),o})}loadNode(e){const t=this.json,i=this,s=t.nodes[e],n=i._loadNodeShallow(e),o=[],a=s.children||[];for(let l=0,h=a.length;l<h;l++)o.push(i.getDependency("node",a[l]));const c=s.skin===void 0?Promise.resolve(null):i.getDependency("skin",s.skin);return Promise.all([n,Promise.all(o),c]).then(function(l){const h=l[0],d=l[1],u=l[2];u!==null&&h.traverse(function(p){p.isSkinnedMesh&&p.bind(u,Mn)});for(let p=0,f=d.length;p<f;p++)h.add(d[p]);return h})}_loadNodeShallow(e){const t=this.json,i=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const n=t.nodes[e],o=n.name?s.createUniqueName(n.name):"",a=[],c=s._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return c&&a.push(c),n.camera!==void 0&&a.push(s.getDependency("camera",n.camera).then(function(l){return s._getNodeRef(s.cameraCache,n.camera,l)})),s._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){a.push(l)}),this.nodeCache[e]=Promise.all(a).then(function(l){let h;if(n.isBone===!0?h=new Xs:l.length>1?h=new Se:l.length===1?h=l[0]:h=new Xt,h!==l[0])for(let d=0,u=l.length;d<u;d++)h.add(l[d]);if(n.name&&(h.userData.name=n.name,h.name=o),J(h,n),n.extensions&&re(i,h,n),n.matrix!==void 0){const d=new Ge;d.fromArray(n.matrix),h.applyMatrix4(d)}else n.translation!==void 0&&h.position.fromArray(n.translation),n.rotation!==void 0&&h.quaternion.fromArray(n.rotation),n.scale!==void 0&&h.scale.fromArray(n.scale);return s.associations.has(h)||s.associations.set(h,{}),s.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],s=this,n=new Se;i.name&&(n.name=s.createUniqueName(i.name)),J(n,i),i.extensions&&re(t,n,i);const o=i.nodes||[],a=[];for(let c=0,l=o.length;c<l;c++)a.push(s.getDependency("node",o[c]));return Promise.all(a).then(function(c){for(let h=0,d=c.length;h<d;h++)n.add(c[h]);const l=h=>{const d=new Map;for(const[u,p]of s.associations)(u instanceof Oe||u instanceof mt)&&d.set(u,p);return h.traverse(u=>{const p=s.associations.get(u);p!=null&&d.set(u,p)}),d};return s.associations=l(n),n})}_createAnimationTracks(e,t,i,s,n){const o=[],a=e.name?e.name:e.uuid,c=[];ie[n.path]===ie.weights?e.traverse(function(u){u.morphTargetInfluences&&c.push(u.name?u.name:u.uuid)}):c.push(a);let l;switch(ie[n.path]){case ie.weights:l=gt;break;case ie.rotation:l=yt;break;case ie.position:case ie.scale:l=ft;break;default:switch(i.itemSize){case 1:l=gt;break;case 2:case 3:default:l=ft;break}break}const h=s.interpolation!==void 0?An[s.interpolation]:Qt,d=this._getArrayFromAccessor(i);for(let u=0,p=c.length;u<p;u++){const f=new l(c[u]+"."+ie[n.path],t.array,d,h);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(f),o.push(f)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=lt(t.constructor),s=new Float32Array(t.length);for(let n=0,o=t.length;n<o;n++)s[n]=t[n]*i;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const s=this instanceof yt?_n:ns;return new s(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Rn(r,e,t){const i=e.attributes,s=new Qs;if(i.POSITION!==void 0){const a=t.json.accessors[i.POSITION],c=a.min,l=a.max;if(c!==void 0&&l!==void 0){if(s.set(new F(c[0],c[1],c[2]),new F(l[0],l[1],l[2])),a.normalized){const h=lt(pe[a.componentType]);s.min.multiplyScalar(h),s.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const n=e.targets;if(n!==void 0){const a=new F,c=new F;for(let l=0,h=n.length;l<h;l++){const d=n[l];if(d.POSITION!==void 0){const u=t.json.accessors[d.POSITION],p=u.min,f=u.max;if(p!==void 0&&f!==void 0){if(c.setX(Math.max(Math.abs(p[0]),Math.abs(f[0]))),c.setY(Math.max(Math.abs(p[1]),Math.abs(f[1]))),c.setZ(Math.max(Math.abs(p[2]),Math.abs(f[2]))),u.normalized){const y=lt(pe[u.componentType]);c.multiplyScalar(y)}a.max(c)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(a)}r.boundingBox=s;const o=new Js;s.getCenter(o.center),o.radius=s.min.distanceTo(s.max)/2,r.boundingSphere=o}function Pt(r,e,t){const i=e.attributes,s=[];function n(o,a){return t.getDependency("accessor",o).then(function(c){r.setAttribute(a,c)})}for(const o in i){const a=ct[o]||o.toLowerCase();a in r.attributes||s.push(n(i[o],a))}if(e.indices!==void 0&&!r.index){const o=t.getDependency("accessor",e.indices).then(function(a){r.setIndex(a)});s.push(o)}return ot.workingColorSpace!==X&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${ot.workingColorSpace}" not supported.`),J(r,e),Rn(r,e,t),Promise.all(s).then(function(){return e.targets!==void 0?Sn(r,e.targets,t):r})}const Je=new WeakMap;class Ln extends Kt{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,s){const n=new Be(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,o=>{this.parse(o,t,s)},i,s)}parse(e,t,i=()=>{}){this.decodeDracoFile(e,t,null,null,oe,i).catch(i)}decodeDracoFile(e,t,i,s,n=X,o=()=>{}){const a={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:n};return this.decodeGeometry(e,a).then(t).catch(o)}decodeGeometry(e,t){const i=JSON.stringify(t);if(Je.has(e)){const c=Je.get(e);if(c.key===i)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const n=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(n,o).then(c=>(s=c,new Promise((l,h)=>{s._callbacks[n]={resolve:l,reject:h},s.postMessage({type:"decode",id:n,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return a.catch(()=>!0).then(()=>{s&&n&&this._releaseTask(s,n)}),Je.set(e,{key:i,promise:a}),a}_createGeometry(e){const t=new ht;e.index&&t.setIndex(new Te(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const s=e.attributes[i],n=s.name,o=s.array,a=s.itemSize,c=new Te(o,a);n==="color"&&(this._assignVertexColorSpace(c,s.vertexColorSpace),c.normalized=!(o instanceof Float32Array)),t.setAttribute(n,c)}return t}_assignVertexColorSpace(e,t){if(t!==oe)return;const i=new te;for(let s=0,n=e.count;s<n;s++)i.fromBufferAttribute(e,s),ot.toWorkingColorSpace(i,oe),e.setXYZ(s,i.r,i.g,i.b)}_loadLibrary(e,t){const i=new Be(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise((s,n)=>{i.load(e,s,void 0,n)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(i=>{const s=i[0];e||(this.decoderConfig.wasmBinary=i[1]);const n=In.toString(),o=["/* draco decoder */",s,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(n){const o=n.data;switch(o.type){case"decode":s._callbacks[o.id].resolve(o);break;case"error":s._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,n){return s._taskLoad>n._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function In(){let r,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":r=a.decoderConfig,e=new Promise(function(h){r.onModuleLoaded=function(d){h({draco:d})},DracoDecoderModule(r)});break;case"decode":const c=a.buffer,l=a.taskConfig;e.then(h=>{const d=h.draco,u=new d.Decoder;try{const p=t(d,u,new Int8Array(c),l),f=p.attributes.map(y=>y.array.buffer);p.index&&f.push(p.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:p},f)}catch(p){console.error(p),self.postMessage({type:"error",id:a.id,error:p.message})}finally{d.destroy(u)}});break}};function t(o,a,c,l){const h=l.attributeIDs,d=l.attributeTypes;let u,p;const f=a.GetEncodedGeometryType(c);if(f===o.TRIANGULAR_MESH)u=new o.Mesh,p=a.DecodeArrayToMesh(c,c.byteLength,u);else if(f===o.POINT_CLOUD)u=new o.PointCloud,p=a.DecodeArrayToPointCloud(c,c.byteLength,u);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!p.ok()||u.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+p.error_msg());const y={index:null,attributes:[]};for(const g in h){const b=self[d[g]];let _,S;if(l.useUniqueIDs)S=h[g],_=a.GetAttributeByUniqueId(u,S);else{if(S=a.GetAttributeId(u,o[h[g]]),S===-1)continue;_=a.GetAttribute(u,S)}const T=s(o,a,u,g,b,_);g==="color"&&(T.vertexColorSpace=l.vertexColorSpace),y.attributes.push(T)}return f===o.TRIANGULAR_MESH&&(y.index=i(o,a,u)),o.destroy(u),y}function i(o,a,c){const h=c.num_faces()*3,d=h*4,u=o._malloc(d);a.GetTrianglesUInt32Array(c,d,u);const p=new Uint32Array(o.HEAPF32.buffer,u,h).slice();return o._free(u),{array:p,itemSize:1}}function s(o,a,c,l,h,d){const u=d.num_components(),f=c.num_points()*u,y=f*h.BYTES_PER_ELEMENT,g=n(o,h),b=o._malloc(y);a.GetAttributeDataArrayForAllPoints(c,d,g,y,b);const _=new h(o.HEAPF32.buffer,b,f).slice();return o._free(b),{name:l,array:_,itemSize:u}}function n(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}const Pn="/assets/models",Cn="https://www.gstatic.com/draco/versioned/decoders/1.5.7/",Ct={buildings:{townhall:{path:"buildings/TownHall.glb",priority:1},barracks:{path:"buildings/Barracks.glb",priority:2},farm:{path:"buildings/Farm.glb",priority:2},house:{path:"buildings/House.glb",priority:3},library:{path:"buildings/Library.glb",priority:2},market:{path:"buildings/Market.glb",priority:3},stables:{path:"buildings/Stables.glb",priority:3},workshop:{path:"buildings/Workshop.glb",priority:2},nightelf_barracks:{path:"../models/nightelf_barracks.glb",priority:2},nightelf_townhall:{path:"../models/nightelf_townhall.glb",priority:1},nightelf_tower:{path:"../models/nightelf_tower.glb",priority:2},nightelf_farm:{path:"../models/nightelf_farm.glb",priority:2},nightelf_library:{path:"../models/nightelf_library.glb",priority:2},human_townhall:{path:"../models/human_townhall.glb",priority:1},human_barracks:{path:"../models/human_barracks.glb",priority:2},human_tower:{path:"../models/human_tower.glb",priority:2},human_farm:{path:"../models/human_farm.glb",priority:2},human_library:{path:"../models/human_library.glb",priority:2},orc_townhall:{path:"../models/orc_townhall.glb",priority:1},orc_barracks:{path:"../models/orc_barracks.glb",priority:2},orc_tower:{path:"../models/orc_tower.glb",priority:2},orc_farm:{path:"../models/orc_farm.glb",priority:2},orc_library:{path:"../models/orc_library.glb",priority:2},undead_townhall:{path:"../models/undead_townhall.glb",priority:1},undead_barracks:{path:"../models/undead_barracks.glb",priority:2},undead_tower:{path:"../models/undead_tower.glb",priority:2},undead_farm:{path:"../models/undead_farm.glb",priority:2},undead_library:{path:"../models/undead_library.glb",priority:2}},units:{cart:{path:"units/Cart.glb",priority:1},worker_drone:{path:"units/worker_drone.glb",priority:1},worker_bot:{path:"units/worker_bot.glb",priority:1},worker_delivery:{path:"units/worker_delivery.glb",priority:1},blazecraft_drone:{path:"../models/worker_drone.glb",priority:1},nightelf_archer:{path:"../models/nightelf_archer.glb",priority:2},nightelf_mage:{path:"../models/nightelf_mage.glb",priority:2},nightelf_warrior:{path:"../models/nightelf_warrior.glb",priority:2},nightelf_cavalry:{path:"../models/nightelf_cavalry.glb",priority:3},nightelf_catapult:{path:"../models/nightelf_catapult.glb",priority:3},nightelf_hero:{path:"../models/nightelf_hero.glb",priority:2},human_archer:{path:"../models/human_archer.glb",priority:2},human_mage:{path:"../models/human_mage.glb",priority:2},human_warrior:{path:"../models/human_warrior.glb",priority:2},human_cavalry:{path:"../models/human_cavalry.glb",priority:3},human_catapult:{path:"../models/human_catapult.glb",priority:3},human_hero:{path:"../models/human_hero.glb",priority:2},orc_warrior:{path:"../models/orc_warrior.glb",priority:2},orc_shaman:{path:"../models/orc_shaman.glb",priority:2},orc_archer:{path:"../models/orc_archer.glb",priority:2},orc_cavalry:{path:"../models/orc_cavalry.glb",priority:3},orc_catapult:{path:"../models/orc_catapult.glb",priority:3},orc_hero:{path:"../models/orc_hero.glb",priority:2},undead_warrior:{path:"../models/undead_warrior.glb",priority:2},undead_necromancer:{path:"../models/undead_necromancer.glb",priority:2},undead_archer:{path:"../models/undead_archer.glb",priority:2},undead_cavalry:{path:"../models/undead_cavalry.glb",priority:3},undead_catapult:{path:"../models/undead_catapult.glb",priority:3},undead_hero:{path:"../models/undead_hero.glb",priority:2}},mascot:{blaze:{path:"mascot/blaze.glb",priority:1},blaze_3d:{path:"../models/blaze_mascot.glb",priority:1}},terrain:{ground_burned:{path:"../models/ground_plane.glb",priority:1},blazecraft_scene:{path:"../models/blazecraft_scene.glb",priority:1}},props:{barrel:{path:"props/barrel.glb",priority:3},lantern:{path:"props/lantern.glb",priority:3},trophy_cup:{path:"props/trophy_cup.glb",priority:3},baseball_scoreboard:{path:"props/baseball_scoreboard.glb",priority:4},football_goalpost:{path:"props/football_goalpost.glb",priority:4},traffic_cone:{path:"props/traffic_cone.glb",priority:4}},environment:{crystal:{path:"../models/env_crystal.glb",priority:3},tree:{path:"../models/env_tree.glb",priority:3},rock:{path:"../models/env_rock.glb",priority:3}},construction:{townhall_0:{path:"buildings/construction/TownHall_0.glb",priority:3},townhall_1:{path:"buildings/construction/TownHall_1.glb",priority:3},barracks_0:{path:"buildings/construction/Barracks_0.glb",priority:3},barracks_1:{path:"buildings/construction/Barracks_1.glb",priority:3},farm_0:{path:"buildings/construction/Farm_0.glb",priority:3},farm_1:{path:"buildings/construction/Farm_1.glb",priority:3},house_0:{path:"buildings/construction/House_0.glb",priority:4},house_1:{path:"buildings/construction/House_1.glb",priority:4},library_0:{path:"buildings/construction/Library_0.glb",priority:3},library_1:{path:"buildings/construction/Library_1.glb",priority:3},market_0:{path:"buildings/construction/Market_0.glb",priority:4},market_1:{path:"buildings/construction/Market_1.glb",priority:4},stables_0:{path:"buildings/construction/Stables_0.glb",priority:4},stables_1:{path:"buildings/construction/Stables_1.glb",priority:4},workshop_0:{path:"buildings/construction/Workshop_0.glb",priority:3},workshop_1:{path:"buildings/construction/Workshop_1.glb",priority:3}}};class Dn{constructor(){this.cache=new Map,this.pending=new Map,this.failed=new Set,this.gltfLoader=new qi,this.dracoLoader=new Ln,this.dracoLoader.setDecoderPath(Cn),this.gltfLoader.setDRACOLoader(this.dracoLoader),this.onProgress=null,this.totalAssets=0,this.loadedAssets=0}async load(e,t){const i=`${e}/${t}`;if(this.cache.has(i))return this.cache.get(i)??null;if(this.pending.has(i))return this.pending.get(i)??null;if(this.failed.has(i))return null;const s=Ct[e];if(!s||!s[t])return console.warn(`Asset not in manifest: ${i}`),null;const n=`${Pn}/${s[t].path}`,o=this.loadGLB(n).then(a=>{var c;return this.cache.set(i,a),this.pending.delete(i),this.loadedAssets++,(c=this.onProgress)==null||c.call(this,this.loadedAssets,this.totalAssets),a}).catch(a=>(console.error(`Failed to load ${i}:`,a),this.failed.add(i),this.pending.delete(i),null));return this.pending.set(i,o),o}loadGLB(e){return new Promise((t,i)=>{this.gltfLoader.load(e,s=>{const n=s.scene;n.traverse(o=>{if(o instanceof B&&(o.castShadow=!0,o.receiveShadow=!0,o.material)){const a=o.material;a instanceof z&&(a.roughness=Math.max(a.roughness,.4),a.envMapIntensity=.8)}}),t({model:n,animations:s.animations||[]})},void 0,i)})}getClone(e,t){const i=`${e}/${t}`,s=this.cache.get(i);if(!s)return null;const n=s.model.clone();return n.traverse(o=>{o instanceof B&&o.material&&(Array.isArray(o.material)?o.material=o.material.map(a=>a.clone()):o.material=o.material.clone())}),n}async preloadByPriority(e){const t=[];for(const[s,n]of Object.entries(Ct))for(const[o,a]of Object.entries(n))a.priority<=e&&t.push({category:s,key:o,priority:a.priority});t.sort((s,n)=>s.priority-n.priority),this.totalAssets=t.length,this.loadedAssets=0;const i=4;for(let s=0;s<t.length;s+=i){const n=t.slice(s,s+i);await Promise.all(n.map(o=>this.load(o.category,o.key)))}}isLoaded(e,t){return this.cache.has(`${e}/${t}`)}getLoadedKeys(){return Array.from(this.cache.keys())}dispose(){for(const e of this.cache.values())e.model.traverse(t=>{var i,s;t instanceof B&&((i=t.geometry)==null||i.dispose(),Array.isArray(t.material)?t.material.forEach(n=>n.dispose()):(s=t.material)==null||s.dispose())});this.cache.clear(),this.pending.clear(),this.failed.clear(),this.dracoLoader.dispose()}}const q=new Dn,Nn={townhall:"townhall",barracks:"barracks",farm:"farm",forge:"workshop",library:"library",tower:"house",workshop:"workshop",archive:"library"},On={townhall:1.2,barracks:.9,farm:.85,forge:.85,library:.9,tower:.6,workshop:.95,archive:.8},Dt=.1,Fn=640,Bn=360;class Gn{constructor(e){this.scene=e,this.meshes=new Map,this.state=new Map,this.selectedId=null,this.selectionRing=this.createSelectionRing(),this.selectionRing.visible=!1,e.add(this.selectionRing),this.sparksGeometry=new ht,this.sparksMaterial=new Vt({color:15232044,size:.3,transparent:!0,opacity:.8,blending:jt}),this.sparks=new Zt(this.sparksGeometry,this.sparksMaterial),this.sparks.visible=!1,e.add(this.sparks)}createSelectionRing(){const e=new Jt(3,3.3,32),t=new K({color:15232044,side:He,transparent:!0,opacity:.8}),i=new B(e,t);return i.rotation.x=-Math.PI/2,i.position.y=.02,i}canvasToWorld(e){return{x:(e.x-Fn)*Dt,z:(e.y-Bn)*Dt}}async sync(e){const t=new Set(e.map(i=>i.id));for(const[i,s]of this.meshes)t.has(i)||(this.scene.remove(s),this.meshes.delete(i),this.state.delete(i));for(const i of e){const s=this.meshes.get(i.id),n=this.state.get(i.id);s?(n&&(this.getConstructionStage(i.constructionProgress)!==this.getConstructionStage(n.progress)||i.tier!==n.tier)&&await this.updateBuildingModel(i),this.updateBuildingAppearance(i,s)):await this.spawnBuilding(i),this.state.set(i.id,{progress:i.constructionProgress,tier:i.tier})}}getConstructionStage(e){return e>=100?"complete":e>=50?"stage1":"stage0"}async spawnBuilding(e){const t=Nn[e.type];if(!t){console.warn(`No asset mapping for building type: ${e.type}`);return}let i="buildings",s=t;if(e.isConstructing&&e.constructionProgress<100){const h=e.constructionProgress<50?"0":"1";i="construction",s=`${t}_${h}`}q.isLoaded(i,s)||await q.load(i,s);const o=q.getClone(i,s);if(!o){const h=this.createPlaceholder(e);this.meshes.set(e.id,h),this.scene.add(h);return}const a=this.canvasToWorld(e.position);o.position.set(a.x,0,a.z);const c=On[e.type]||1,l=1+(e.tier-1)*.1;o.scale.setScalar(c*l),o.name=e.id,o.userData.buildingId=e.id,o.userData.buildingType=e.type,this.meshes.set(e.id,o),this.scene.add(o),this.updateBuildingAppearance(e,o)}async updateBuildingModel(e){const t=this.meshes.get(e.id);t&&(this.scene.remove(t),this.meshes.delete(e.id)),await this.spawnBuilding(e)}updateBuildingAppearance(e,t){const i=e.isConstructing?.4+e.constructionProgress/100*.6:1;t.traverse(s=>{if(s instanceof B&&s.material){const n=s.material;n instanceof z&&(n.transparent=i<1,n.opacity=i)}})}createPlaceholder(e){const t=Ee[e.type],i=t==null?void 0:t.tiers[e.tier-1],s=e.size.w/10*.8,n=e.size.h/10*.8,o=2+e.tier*.5,a=new es(s,o,n),c=new z({color:(i==null?void 0:i.accent)||6710886,roughness:.7,metalness:.2}),l=new B(a,c);l.position.y=o/2,l.castShadow=!0,l.receiveShadow=!0;const h=new Se;h.add(l);const d=this.canvasToWorld(e.position);return h.position.set(d.x,0,d.z),h.name=e.id,h.userData.buildingId=e.id,h.userData.buildingType=e.type,h}select(e){if(this.selectedId=e,!e){this.selectionRing.visible=!1;return}const t=this.meshes.get(e);t&&(this.selectionRing.position.x=t.position.x,this.selectionRing.position.z=t.position.z,this.selectionRing.visible=!0)}raycast(e){const t=Array.from(this.meshes.values()),i=e.intersectObjects(t,!0);for(const s of i){let n=s.object;for(;n&&!n.userData.buildingId;)n=n.parent;if(n!=null&&n.userData.buildingId)return n.userData.buildingId}return null}update(e,t){if(this.selectionRing.visible){this.selectionRing.rotation.z=t*.001;const i=Math.sin(t*.003)*.1+.9;this.selectionRing.scale.setScalar(i)}}getMesh(e){return this.meshes.get(e)}dispose(){for(const e of this.meshes.values())this.scene.remove(e);this.meshes.clear(),this.state.clear(),this.scene.remove(this.selectionRing),this.scene.remove(this.sparks),this.selectionRing.geometry.dispose(),this.selectionRing.material instanceof Oe&&this.selectionRing.material.dispose(),this.sparksGeometry.dispose(),this.sparksMaterial.dispose()}}const Hn=!0,be={idle:13421772,moving:12539648,working:2278750,blocked:15680580,hold:15381256,complete:2278750,terminated:7041664},Nt=.1,$n=640,Un=360,jn=8,Pe=.6;class Wn{constructor(e){this.scene=e,this.meshes=new Map,this.positions=new Map,this.selectedIds=new Set,this.selectionRings=new Map,this.ringGeometry=new Jt(1,1.15,32),this.ringMaterial=new K({color:12539648,side:He,transparent:!0,opacity:.9}),this.statusMaterials=new Map;for(const[t,i]of Object.entries(be)){const s=new z({color:i,roughness:.5,metalness:.1,transparent:t==="terminated",opacity:t==="terminated"?.5:1});this.statusMaterials.set(t,s)}this.workerModelTypes=["worker_drone","worker_bot","worker_delivery"],this.workerModelsLoaded=!1,this.loadWorkerModels();{const t=new ei(10);t.name="debug-axes",e.add(t);for(let i=-60;i<=60;i+=20)for(let s=-30;s<=30;s+=20){const n=new B(new We(.3),new K({color:4473924}));n.position.set(i,.1,s),n.name="debug-marker",e.add(n)}console.log("[Worker3D] Debug mode enabled. Axes: R=X, G=Y, B=Z"),console.log("[Worker3D] Canvas center (640,360) â†’ World origin (0,0)")}}async loadWorkerModels(){try{const e=this.workerModelTypes.map(async t=>{q.isLoaded("units",t)||await q.load("units",t)});await Promise.all(e),this.workerModelsLoaded=this.workerModelTypes.some(t=>q.isLoaded("units",t)),Hn&&this.workerModelsLoaded&&console.log("[Worker3D] GLB worker models loaded")}catch{this.workerModelsLoaded=!1}}getWorkerModelType(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t=t&t;const i=Math.abs(t)%this.workerModelTypes.length;return this.workerModelTypes[i]}canvasToWorld(e){return{x:(e.x-$n)*Nt,z:(e.y-Un)*Nt}}async sync(e){const t=new Set(e.map(i=>i.id));for(const[i,s]of this.meshes)if(!t.has(i)){this.scene.remove(s),this.meshes.delete(i),this.positions.delete(i);const n=this.selectionRings.get(i);n&&(this.scene.remove(n),this.selectionRings.delete(i))}for(const i of e){const s=this.meshes.get(i.id);if(!s)await this.spawnWorker(i);else{const n=this.positions.get(i.id);if(n){const o=this.canvasToWorld(i.position);n.target.set(o.x,.5,o.z),n.status=i.status}this.updateWorkerAppearance(i,s)}}}async spawnWorker(e){let t;if(this.workerModelsLoaded){const s=this.getWorkerModelType(e.id);t=q.getClone("units",s),t&&(t.scale.setScalar(Pe),t.userData.modelType=s)}t||(t=this.createProceduralWorker(e));const i=this.canvasToWorld(e.position);t.position.set(i.x,.5,i.z),console.log(`[Worker3D] Spawned "${e.name}" (${e.id.slice(0,8)})`),console.log(`  Canvas: (${e.position.x.toFixed(0)}, ${e.position.y.toFixed(0)})`),console.log(`  World:  (${i.x.toFixed(1)}, 0.5, ${i.z.toFixed(1)})`),console.log(`  Status: ${e.status}`),this.positions.set(e.id,{current:new F(i.x,.5,i.z),target:new F(i.x,.5,i.z),status:e.status}),t.name=e.id,t.userData.workerId=e.id,t.userData.workerName=e.name,this.meshes.set(e.id,t),this.scene.add(t),this.updateWorkerAppearance(e,t)}createProceduralWorker(e){const t=new Se,i=be[e.status]||be.idle,s=new ti(.5,.6,.2,12),n=new z({color:2763306,roughness:.4,metalness:.6}),o=new B(s,n);o.position.y=.1,o.castShadow=!0,o.receiveShadow=!0,t.add(o);const a=new es(.7,.5,.9);a.translate(0,.45,0);const c=new z({color:i,roughness:.3,metalness:.2}),l=new B(a,c);l.castShadow=!0,l.receiveShadow=!0,l.name="worker-body",t.add(l);const h=new We(.25,12,8,0,Math.PI*2,0,Math.PI/2),d=new z({color:1710618,roughness:.1,metalness:.8}),u=new B(h,d);u.position.y=.7,u.position.z=.15,u.castShadow=!0,t.add(u);const p=new si;p.moveTo(0,.2),p.lineTo(-.15,-.1),p.lineTo(.15,-.1),p.closePath();const f=new ii(p),y=new K({color:12539648,side:He}),g=new B(f,y);g.rotation.x=-Math.PI/2,g.position.y=.22,g.position.z=.7,t.add(g);const b=new We(.08,8,8),_=new K({color:i}),S=new B(b,_);return S.position.y=.75,S.position.z=-.3,S.name="status-light",t.add(S),t.userData.isProcedural=!0,t.scale.setScalar(Pe),t}getStatusMaterial(e){return this.statusMaterials.get(e)||this.statusMaterials.get("idle")}updateWorkerAppearance(e,t){const i=be[e.status]||be.idle,s=e.status==="terminated";t.traverse(n=>{if(n instanceof B&&n.material){if(n.name==="worker-body"){const o=n.material;o instanceof z&&(o.color.setHex(i),o.transparent=s,o.opacity=s?.5:1)}if(n.name==="status-light"){const o=n.material;o instanceof K&&o.color.setHex(i)}}})}select(e){for(const[t,i]of this.selectionRings)e.includes(t)||(this.scene.remove(i),this.selectionRings.delete(t));this.selectedIds=new Set(e);for(const t of e)if(!this.selectionRings.has(t)){const i=this.meshes.get(t);if(i){const s=this.createSelectionRing();s.position.copy(i.position),s.position.y=.02,this.scene.add(s),this.selectionRings.set(t,s)}}}createSelectionRing(){const e=new B(this.ringGeometry,this.ringMaterial.clone());return e.rotation.x=-Math.PI/2,e}raycast(e){const t=Array.from(this.meshes.values()),i=e.intersectObjects(t,!0);for(const s of i){let n=s.object;for(;n&&!n.userData.workerId;)n=n.parent;if(n!=null&&n.userData.workerId)return n.userData.workerId}return null}update(e,t){for(const[i,s]of this.positions){const n=this.meshes.get(i);if(!n)continue;const o=Math.min(1,jn*e);s.current.lerp(s.target,o),n.position.copy(s.current);const a=s.target.x-s.current.x,c=s.target.z-s.current.z;if((Math.abs(a)>.01||Math.abs(c)>.01)&&(n.rotation.y=Math.atan2(a,c)),s.status==="moving")n.position.y=.5+Math.sin(t*.008)*.05;else if(s.status==="working"){const h=1+Math.sin(t*.006)*.03;n.scale.setScalar(Pe*h)}else n.position.y=.5,n.scale.setScalar(Pe);const l=this.selectionRings.get(i);if(l){l.position.x=n.position.x,l.position.z=n.position.z,l.rotation.z=t*.001;const h=Math.sin(t*.003)*.1+.9;l.scale.setScalar(h)}}}getMesh(e){return this.meshes.get(e)}getWorkerIds(){return Array.from(this.meshes.keys())}dispose(){for(const e of this.meshes.values())this.scene.remove(e);this.meshes.clear(),this.positions.clear();for(const e of this.selectionRings.values())this.scene.remove(e);this.selectionRings.clear(),this.selectedIds.clear(),this.ringGeometry.dispose(),this.ringMaterial.dispose();for(const e of this.statusMaterials.values())e.dispose();this.statusMaterials.clear()}}const zn="ws://localhost:7778",Kn=3e3,Xn=5;class qn{constructor(){this.ws=null,this.reconnectAttempts=0,this.connected=!1,this.eventListeners=[],this.statsListeners=[],this.connectionListeners=[],this.stats={spawns:0,commands:0,production:0,research:0,repairs:0,storage:0,defense:0},this.eventHistory=[]}connect(){if(!(this.ws&&this.ws.readyState===WebSocket.OPEN))try{this.ws=new WebSocket(zn),this.ws.onopen=()=>{console.log("[Bridge] Connected to aggregator"),this.connected=!0,this.reconnectAttempts=0,this.notifyConnection(!0)},this.ws.onclose=()=>{console.log("[Bridge] Disconnected from aggregator"),this.connected=!1,this.notifyConnection(!1),this.scheduleReconnect()},this.ws.onerror=e=>{console.warn("[Bridge] WebSocket error:",e)},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.handleMessage(t)}catch(t){console.error("[Bridge] Failed to parse message:",t)}}}catch(e){console.warn("[Bridge] Failed to connect:",e),this.scheduleReconnect()}}handleMessage(e){e.type==="init"?(e.stats&&(this.stats={...e.stats},this.notifyStats(this.stats)),e.events&&(this.eventHistory=e.events,e.events.forEach(t=>this.notifyEvent(t)))):e.type==="event"&&(e.event&&(this.eventHistory.push(e.event),this.eventHistory.length>100&&this.eventHistory.shift(),this.notifyEvent(e.event)),e.stats&&(this.stats={...e.stats},this.notifyStats(this.stats)))}scheduleReconnect(){if(this.reconnectAttempts>=Xn){console.log("[Bridge] Max reconnect attempts reached, giving up");return}this.reconnectAttempts++;const e=Kn*Math.pow(1.5,this.reconnectAttempts-1);console.log(`[Bridge] Reconnecting in ${Math.round(e/1e3)}s (attempt ${this.reconnectAttempts})`),setTimeout(()=>{this.connect()},e)}onEvent(e){return this.eventListeners.push(e),()=>{const t=this.eventListeners.indexOf(e);t>=0&&this.eventListeners.splice(t,1)}}onStats(e){return this.statsListeners.push(e),e(this.stats),()=>{const t=this.statsListeners.indexOf(e);t>=0&&this.statsListeners.splice(t,1)}}onConnection(e){return this.connectionListeners.push(e),e(this.connected),()=>{const t=this.connectionListeners.indexOf(e);t>=0&&this.connectionListeners.splice(t,1)}}notifyEvent(e){this.eventListeners.forEach(t=>{try{t(e)}catch(i){console.error("[Bridge] Event listener error:",i)}})}notifyStats(e){this.statsListeners.forEach(t=>{try{t(e)}catch(i){console.error("[Bridge] Stats listener error:",i)}})}notifyConnection(e){this.connectionListeners.forEach(t=>{try{t(e)}catch(i){console.error("[Bridge] Connection listener error:",i)}})}getStats(){return{...this.stats}}isConnected(){return this.connected}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}}const Ce=new qn,et="bsi_blazecraft_faction",tt={productionSpeed:1,goldBonus:0,moraleBonus:0,crisisDuration:1,influenceBonus:0,intelBonus:0},st={production:{name:"Production",description:"+15% production speed, +10% gold",check:r=>(r.runsPerGame??0)>=5||(r.pointsPerGame??0)>=25,apply:r=>{r.productionSpeed*=1.15,r.goldBonus+=10}},defense:{name:"Defense",description:"+20% morale, -20% crisis duration",check:r=>(r.era??999)<=3.5||(r.pointsAllowed??999)<=20,apply:r=>{r.moraleBonus+=20,r.crisisDuration*=.8}},momentum:{name:"Momentum",description:"+25% influence",check:r=>(r.winStreak??0)>=5,apply:r=>{r.influenceBonus+=25}},discipline:{name:"Discipline",description:"-15% crisis duration",check:r=>(r.errors??999)<=50,apply:r=>{r.crisisDuration*=.85}},intel:{name:"Intel",description:"+15% intel gain",check:r=>(r.wins&&r.losses?r.wins/(r.wins+r.losses):0)>=.6,apply:r=>{r.intelBonus+=15}}};class Yn{constructor(){this.teamId=null,this.league=null,this.stats=null,this.modifiers={...tt},this.activeTraits=[],this.listeners=[],this.loadFromStorage()}setFaction(e,t,i={}){this.teamId=e,this.league=t,this.stats=i,this.modifiers=this.calculateModifiers(i);const s={teamId:e,league:t,selectedAt:Date.now()};this.saveToStorage(s),this.notifyListeners(s)}clearFaction(){this.teamId=null,this.league=null,this.stats=null,this.modifiers={...tt},this.activeTraits=[],localStorage.removeItem(et),this.notifyListeners(null)}updateStats(e){this.teamId&&(this.stats=e,this.modifiers=this.calculateModifiers(e),this.notifyListeners({teamId:this.teamId,league:this.league,selectedAt:Date.now()}))}calculateModifiers(e){const t={...tt};this.activeTraits=[];for(const[i,s]of Object.entries(st))s.check(e)&&(s.apply(t),this.activeTraits.push(i));return t}applyModifiers(e){const t={...e};return t.gold!==void 0&&t.gold>0&&(t.gold=Math.round(t.gold*(1+this.modifiers.goldBonus/100))),t.intel!==void 0&&t.intel>0&&(t.intel=Math.round(t.intel*(1+this.modifiers.intelBonus/100))),t.influence!==void 0&&t.influence>0&&(t.influence=Math.round(t.influence*(1+this.modifiers.influenceBonus/100))),t.morale!==void 0&&(t.morale=Math.round(t.morale+this.modifiers.moraleBonus)),t}applyCrisisDuration(e){return Math.round(e*this.modifiers.crisisDuration)}applyProductionSpeed(e){return e*this.modifiers.productionSpeed}hasFaction(){return this.teamId!==null}getFaction(){return!this.teamId||!this.league?null:{teamId:this.teamId,league:this.league,selectedAt:Date.now()}}getActiveTraits(){return this.activeTraits.map(e=>({key:e,name:st[e].name,description:st[e].description}))}getModifiers(){return{...this.modifiers}}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notifyListeners(e){for(const t of this.listeners)t(e)}loadFromStorage(){try{const e=localStorage.getItem(et);if(e){const t=JSON.parse(e);this.teamId=t.teamId,this.league=t.league}}catch{}}saveToStorage(e){try{localStorage.setItem(et,JSON.stringify(e))}catch{}}}const ae=new Yn,Vn="/api/gamebridge/stream",Zn=1e3,Qn=3e4,Jn=10,os={WORLD_TICK:"defense",GAME_START:"spawns",GAME_UPDATE:"production",GAME_FINAL:"commands",STANDINGS_DELTA:"defense",LINEUP_POSTED:"research",ODDS_SHIFT:"storage",HIGHLIGHT_CLIP:"production",INJURY_ALERT:"repairs",MOMENTUM_SWING:"defense"};class rs{constructor(e={}){this.endpoint=e.endpoint||Vn,this.mode=e.mode||"spectator",this.tier=e.tier||"free",this.leagues=e.leagues||["mlb","nfl","ncaaf"],this.teams=e.teams||[],this.demoMode=e.demo??!0,this.onEvent=e.onEvent||(()=>{}),this.onStats=e.onStats||(()=>{}),this.onConnection=e.onConnection||(()=>{}),this.onError=e.onError||(()=>{}),this.eventSource=null,this.connected=!1,this.reconnectAttempts=0,this.reconnectTimeout=null,this.stats={spawns:0,commands:0,production:0,research:0,repairs:0,storage:0,defense:0},this.eventHistory=[],this.maxHistorySize=100}buildUrl(){const e=new URLSearchParams({mode:this.mode,leagues:this.leagues.join(","),demo:String(this.demoMode)});return this.teams.length>0&&e.set("teams",this.teams.join(",")),`${this.endpoint}?${e.toString()}`}connect(){this.eventSource&&this.disconnect();const e=this.buildUrl();try{this.eventSource=new EventSource(e),this.eventSource.onopen=()=>{this.connected=!0,this.reconnectAttempts=0,this.onConnection(!0)},this.eventSource.onerror=i=>{var s;this.connected=!1,this.onConnection(!1),((s=this.eventSource)==null?void 0:s.readyState)===EventSource.CLOSED&&this.scheduleReconnect()};const t=["WORLD_TICK","GAME_START","GAME_UPDATE","GAME_FINAL","STANDINGS_DELTA","LINEUP_POSTED","ODDS_SHIFT","HIGHLIGHT_CLIP","INJURY_ALERT","MOMENTUM_SWING"];for(const i of t)this.eventSource.addEventListener(i,s=>{this.handleEvent(s)});this.eventSource.onmessage=i=>{this.handleEvent(i)}}catch(t){this.onError(t instanceof Error?t:new Error(String(t))),this.scheduleReconnect()}}handleEvent(e){try{const t=JSON.parse(e.data);this.eventHistory.unshift(t),this.eventHistory.length>this.maxHistorySize&&(this.eventHistory.length=this.maxHistorySize),this.updateStats(t),this.onEvent(t),this.onStats({...this.stats})}catch(t){this.onError(t instanceof Error?t:new Error("Failed to parse event"))}}updateStats(e){const t=os[e.type];t&&t in this.stats&&this.stats[t]++}scheduleReconnect(){if(this.reconnectAttempts>=Jn){this.onError(new Error("Max reconnection attempts reached"));return}this.reconnectTimeout&&clearTimeout(this.reconnectTimeout);const e=Math.min(Zn*Math.pow(2,this.reconnectAttempts),Qn);this.reconnectAttempts++,this.reconnectTimeout=setTimeout(()=>{this.connect()},e)}disconnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.eventSource&&(this.eventSource.close(),this.eventSource=null),this.connected=!1,this.onConnection(!1)}setMode(e){e!==this.mode&&(this.mode=e,(this.connected||this.eventSource)&&this.connect())}setLeagues(e){this.leagues=e,(this.connected||this.eventSource)&&this.connect()}setDemoMode(e){this.demoMode=e,(this.connected||this.eventSource)&&this.connect()}injectEvent(e){const t={id:crypto.randomUUID(),type:e.type||"WORLD_TICK",timestamp:new Date().toISOString(),source:"sim",priority:e.priority||3,payload:e.payload||{type:"WORLD_TICK",liveGames:0,serverTime:new Date().toISOString()},gameContext:e.gameContext};this.eventHistory.unshift(t),this.eventHistory.length>this.maxHistorySize&&(this.eventHistory.length=this.maxHistorySize),this.updateStats(t),this.onEvent(t),this.onStats({...this.stats})}isConnected(){return this.connected}getStats(){return{...this.stats}}getHistory(){return[...this.eventHistory]}resetStats(){this.stats={spawns:0,commands:0,production:0,research:0,repairs:0,storage:0,defense:0},this.eventHistory=[],this.onStats({...this.stats})}}function eo(r){var s,n,o,a,c,l,h,d,u,p,f,y,g,b,_,S,T,D,C,L;const e=os[r.type]||"production";let t="status",i="";switch(r.type){case"GAME_START":t="spawn",i=r.gameContext?`Game started: ${(s=r.gameContext.awayTeam)==null?void 0:s.name} @ ${(n=r.gameContext.homeTeam)==null?void 0:n.name}`:"New game started";break;case"GAME_UPDATE":t="task_start",i=((o=r.payload)==null?void 0:o.scoringPlay)||"Score update";break;case"GAME_FINAL":t="task_complete",i=r.gameContext?`Final: ${(a=r.gameContext.awayTeam)==null?void 0:a.name} ${(c=r.payload)==null?void 0:c.awayScore} - ${(l=r.gameContext.homeTeam)==null?void 0:l.name} ${(h=r.payload)==null?void 0:h.homeScore}`:"Game concluded";break;case"STANDINGS_DELTA":t="status",i=`Standings shift: ${((d=r.payload)==null?void 0:d.delta)>0?"+":""}${(u=r.payload)==null?void 0:u.delta} positions`;break;case"INJURY_ALERT":t="error",i=`Injury: ${(p=r.payload)==null?void 0:p.playerName} (${(f=r.payload)==null?void 0:f.severity})`;break;case"HIGHLIGHT_CLIP":t="task_complete",i=`Highlight: ${(y=r.payload)==null?void 0:y.description}`;break;case"MOMENTUM_SWING":t="status",i=`Momentum ${((g=r.payload)==null?void 0:g.newWinProb)>((b=r.payload)==null?void 0:b.previousWinProb)?"surge":"shift"}: ${(_=r.payload)==null?void 0:_.favoredTeam} now at ${(S=r.payload)==null?void 0:S.newWinProb}%`;break;case"LINEUP_POSTED":t="status",i=`Lineup posted: ${(T=r.payload)==null?void 0:T.team}`;break;case"ODDS_SHIFT":t="status",i=`Odds ${(D=r.payload)==null?void 0:D.movement}: ${(C=r.payload)==null?void 0:C.direction} moving`;break;case"WORLD_TICK":default:t="status",i=`${((L=r.payload)==null?void 0:L.liveGames)||0} live games`;break}return{type:t,workerId:`bsi-${r.id.slice(0,8)}`,details:i,category:e,timestamp:Date.now()}}new rs;const it={mlb:[{id:"mlb-TEX",name:"Rangers",abbr:"TEX",city:"Texas"},{id:"mlb-HOU",name:"Astros",abbr:"HOU",city:"Houston"},{id:"mlb-NYY",name:"Yankees",abbr:"NYY",city:"New York"},{id:"mlb-LAD",name:"Dodgers",abbr:"LAD",city:"Los Angeles"},{id:"mlb-ATL",name:"Braves",abbr:"ATL",city:"Atlanta"},{id:"mlb-CHC",name:"Cubs",abbr:"CHC",city:"Chicago"},{id:"mlb-BOS",name:"Red Sox",abbr:"BOS",city:"Boston"},{id:"mlb-SF",name:"Giants",abbr:"SF",city:"San Francisco"},{id:"mlb-STL",name:"Cardinals",abbr:"STL",city:"St. Louis"},{id:"mlb-PHI",name:"Phillies",abbr:"PHI",city:"Philadelphia"}],nfl:[{id:"nfl-DAL",name:"Cowboys",abbr:"DAL",city:"Dallas"},{id:"nfl-PHI",name:"Eagles",abbr:"PHI",city:"Philadelphia"},{id:"nfl-KC",name:"Chiefs",abbr:"KC",city:"Kansas City"},{id:"nfl-SF",name:"49ers",abbr:"SF",city:"San Francisco"},{id:"nfl-BUF",name:"Bills",abbr:"BUF",city:"Buffalo"},{id:"nfl-BAL",name:"Ravens",abbr:"BAL",city:"Baltimore"},{id:"nfl-DET",name:"Lions",abbr:"DET",city:"Detroit"},{id:"nfl-MIA",name:"Dolphins",abbr:"MIA",city:"Miami"},{id:"nfl-CIN",name:"Bengals",abbr:"CIN",city:"Cincinnati"},{id:"nfl-GB",name:"Packers",abbr:"GB",city:"Green Bay"}],ncaaf:[{id:"ncaaf-TEX",name:"Longhorns",abbr:"TEX",city:"Texas"},{id:"ncaaf-OSU",name:"Buckeyes",abbr:"OSU",city:"Ohio State"},{id:"ncaaf-BAMA",name:"Crimson Tide",abbr:"BAMA",city:"Alabama"},{id:"ncaaf-UGA",name:"Bulldogs",abbr:"UGA",city:"Georgia"},{id:"ncaaf-LSU",name:"Tigers",abbr:"LSU",city:"LSU"},{id:"ncaaf-MICH",name:"Wolverines",abbr:"MICH",city:"Michigan"},{id:"ncaaf-ND",name:"Fighting Irish",abbr:"ND",city:"Notre Dame"},{id:"ncaaf-TENN",name:"Volunteers",abbr:"TENN",city:"Tennessee"},{id:"ncaaf-PSU",name:"Nittany Lions",abbr:"PSU",city:"Penn State"},{id:"ncaaf-OU",name:"Sooners",abbr:"OU",city:"Oklahoma"}],nba:[{id:"nba-DAL",name:"Mavericks",abbr:"DAL",city:"Dallas"},{id:"nba-BOS",name:"Celtics",abbr:"BOS",city:"Boston"},{id:"nba-LAL",name:"Lakers",abbr:"LAL",city:"Los Angeles"},{id:"nba-GSW",name:"Warriors",abbr:"GSW",city:"Golden State"},{id:"nba-DEN",name:"Nuggets",abbr:"DEN",city:"Denver"},{id:"nba-MIL",name:"Bucks",abbr:"MIL",city:"Milwaukee"},{id:"nba-PHX",name:"Suns",abbr:"PHX",city:"Phoenix"},{id:"nba-MIA",name:"Heat",abbr:"MIA",city:"Miami"}],nhl:[{id:"nhl-DAL",name:"Stars",abbr:"DAL",city:"Dallas"},{id:"nhl-BOS",name:"Bruins",abbr:"BOS",city:"Boston"},{id:"nhl-EDM",name:"Oilers",abbr:"EDM",city:"Edmonton"},{id:"nhl-FLA",name:"Panthers",abbr:"FLA",city:"Florida"},{id:"nhl-COL",name:"Avalanche",abbr:"COL",city:"Colorado"},{id:"nhl-VGK",name:"Golden Knights",abbr:"VGK",city:"Vegas"},{id:"nhl-TOR",name:"Maple Leafs",abbr:"TOR",city:"Toronto"},{id:"nhl-CAR",name:"Hurricanes",abbr:"CAR",city:"Carolina"}]},to={mlb:"MLB",nfl:"NFL",ncaaf:"NCAAF",nba:"NBA",nhl:"NHL"};class so{constructor(e,t,i){this.container=e,this.onSelect=t,this.onSkip=i,this.activeLeague="mlb",this.hoveredTeam=null,this.selectedTeam=null,this.overlay=null,this.render()}render(){this.overlay=document.createElement("div"),this.overlay.className="faction-overlay",this.overlay.innerHTML=`
      <div class="faction-modal">
        <div class="faction-header">
          <h2 class="faction-title">Choose Your Faction</h2>
          <p class="faction-subtitle">Your team's stats determine gameplay modifiers</p>
        </div>

        <div class="faction-tabs" role="tablist">
          ${Object.entries(to).map(([e,t])=>`
            <button
              class="faction-tab ${e===this.activeLeague?"active":""}"
              data-league="${e}"
              role="tab"
              aria-selected="${e===this.activeLeague}"
            >${t}</button>
          `).join("")}
        </div>

        <div class="faction-content">
          <div class="faction-grid" role="listbox" aria-label="Teams">
            ${this.renderTeamGrid()}
          </div>

          <div class="faction-preview">
            <div class="preview-header">
              <span class="preview-title">Preview</span>
            </div>
            <div class="preview-content">
              <div class="preview-team">
                <span class="preview-team-abbr">?</span>
                <span class="preview-team-name">Select a team</span>
              </div>
              <div class="preview-modifiers">
                <div class="preview-modifier-hint">
                  Hover over a team to preview modifiers
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="faction-actions">
          <button class="faction-btn faction-btn-secondary" type="button" data-action="skip">
            Play Without Faction
          </button>
          <button class="faction-btn faction-btn-primary" type="button" data-action="confirm" disabled>
            Confirm Selection
          </button>
        </div>
      </div>
    `,this.attachEventListeners(),this.container.appendChild(this.overlay)}renderTeamGrid(){return it[this.activeLeague].map(t=>`
      <button
        class="faction-team ${this.selectedTeam===t.id?"selected":""}"
        data-team-id="${t.id}"
        data-league="${this.activeLeague}"
        role="option"
        aria-selected="${this.selectedTeam===t.id}"
      >
        <span class="team-abbr">${t.abbr}</span>
        <span class="team-name">${t.name}</span>
        <span class="team-city">${t.city}</span>
      </button>
    `).join("")}attachEventListeners(){this.overlay.addEventListener("click",e=>{const t=e.target.closest(".faction-tab");if(t){const n=t.dataset.league;this.setActiveLeague(n);return}const i=e.target.closest(".faction-team");if(i){this.selectTeam(i.dataset.teamId,i.dataset.league);return}const s=e.target.closest(".faction-btn");if(s){const n=s.dataset.action;n==="skip"?this.skip():n==="confirm"&&this.selectedTeam&&this.confirm()}}),this.overlay.addEventListener("mouseover",e=>{const t=e.target.closest(".faction-team");t&&this.previewTeam(t.dataset.teamId,t.dataset.league)}),this.overlay.addEventListener("mouseout",e=>{e.target.closest(".faction-team")&&!this.selectedTeam&&this.clearPreview()}),this.overlay.addEventListener("keydown",e=>{e.key==="Escape"&&this.skip()})}setActiveLeague(e){this.activeLeague=e,this.selectedTeam=null,this.overlay.querySelectorAll(".faction-tab").forEach(n=>{const o=n.dataset.league===e;n.classList.toggle("active",o),n.setAttribute("aria-selected",String(o))});const i=this.overlay.querySelector(".faction-grid");i&&(i.innerHTML=this.renderTeamGrid());const s=this.overlay.querySelector('[data-action="confirm"]');s&&(s.disabled=!0),this.clearPreview()}selectTeam(e,t){this.selectedTeam=e,this.overlay.querySelectorAll(".faction-team").forEach(n=>{const o=n.dataset.teamId===e;n.classList.toggle("selected",o),n.setAttribute("aria-selected",String(o))});const s=this.overlay.querySelector('[data-action="confirm"]');s&&(s.disabled=!1),this.previewTeam(e,t)}previewTeam(e,t){var c;this.hoveredTeam=e;const i=(c=it[t])==null?void 0:c.find(l=>l.id===e);if(!i)return;const s=this.getMockStats(t),n=ae.calculateModifiers(s),o=Object.entries(n).filter(([l,h])=>l==="productionSpeed"||l==="crisisDuration"?h!==1:h!==0).map(([l,h])=>this.formatModifier(l,h)),a=this.overlay.querySelector(".preview-content");a&&(a.innerHTML=`
        <div class="preview-team">
          <span class="preview-team-abbr">${i.abbr}</span>
          <span class="preview-team-name">${i.city} ${i.name}</span>
        </div>
        <div class="preview-modifiers">
          ${o.length>0?o.map(l=>`
            <div class="preview-modifier">
              <span class="modifier-icon">${l.icon}</span>
              <span class="modifier-text">${l.text}</span>
            </div>
          `).join(""):`
            <div class="preview-modifier preview-modifier-neutral">
              <span class="modifier-text">No modifiers (stats pending)</span>
            </div>
          `}
        </div>
        <div class="preview-note">
          Modifiers update when live team stats are available
        </div>
      `)}clearPreview(){this.hoveredTeam=null;const e=this.overlay.querySelector(".preview-content");e&&(e.innerHTML=`
        <div class="preview-team">
          <span class="preview-team-abbr">?</span>
          <span class="preview-team-name">Select a team</span>
        </div>
        <div class="preview-modifiers">
          <div class="preview-modifier-hint">
            Hover over a team to preview modifiers
          </div>
        </div>
      `)}formatModifier(e,t){var s;const i={productionSpeed:n=>({icon:"+",text:`${Math.round((n-1)*100)}% production speed`}),goldBonus:n=>({icon:"+",text:`${n}% gold gain`}),moraleBonus:n=>({icon:"+",text:`${n}% morale`}),crisisDuration:n=>({icon:"-",text:`${Math.round((1-n)*100)}% crisis duration`}),influenceBonus:n=>({icon:"+",text:`${n}% influence`}),intelBonus:n=>({icon:"+",text:`${n}% intel`})};return((s=i[e])==null?void 0:s.call(i,t))||{icon:"?",text:`${e}: ${t}`}}getMockStats(e){const t={wins:50,losses:40,winStreak:Math.floor(Math.random()*8)};return e==="mlb"?{...t,runsPerGame:4+Math.random()*2,era:3+Math.random()*1.5,errors:40+Math.floor(Math.random()*30)}:{...t,pointsPerGame:22+Math.random()*8,pointsAllowed:18+Math.random()*8}}confirm(){var t;!this.selectedTeam||!((t=it[this.activeLeague])!=null&&t.find(i=>i.id===this.selectedTeam))||(this.onSelect(this.selectedTeam,this.activeLeague),this.close())}skip(){this.onSkip(),this.close()}close(){this.overlay&&(this.overlay.classList.add("faction-overlay-closing"),setTimeout(()=>{this.overlay.remove(),this.overlay=null},200))}show(){this.overlay||this.render()}isVisible(){return this.overlay!==null&&this.container.contains(this.overlay)}}function Ot(r){return new Promise(e=>{new so(r,(t,i)=>e({teamId:t,league:i}),()=>e({teamId:null,league:null}))})}const De={next_score:{name:"Next Score",description:"Which team scores next?",icon:"+"},game_outcome:{name:"Game Winner",description:"Which team wins the game?",icon:"W"},over_under:{name:"Over/Under",description:"Total score above or below target?",icon:"O/U"},first_to_score:{name:"First to Score",description:"Which team scores first?",icon:"1st"}},$={MIN_STAKE:10,MAX_STAKE:500,MAX_CONCURRENT:5,STARTING_GOLD:200,PASSIVE_REGEN_RATE:5,PASSIVE_REGEN_CAP:100},Ne={WALLET:"blazecraft_wallet",PREDICTIONS:"blazecraft_predictions",STATS:"blazecraft_prediction_stats"},io=300*1e3;function Ft(){return{gold:$.STARTING_GOLD,intel:0,influence:0,morale:100,lifetimeEarnings:0,lifetimeLosses:0}}function no(){return`pred-${Date.now()}-${Math.random().toString(36).slice(2,8)}`}const oo=.05;function he(r){if(r<=0)return 100;if(r>=1)return 1.01;const e=1/r;return Math.max(1.01,e*(1-oo))}function Bt(r=50,e=0){let t=r/100;const i=e/400;t=Math.max(.1,Math.min(.9,t+i));const s=.05,n=(1-s)*(1-t),o=(1-s)*t;return{home:he(o),away:he(n),neither:he(s)}}function ro(r=50){const e=Math.max(.05,Math.min(.95,r/100)),t=1-e;return{home:he(e),away:he(t)}}function ao(r,e,t){const i=co(t),s=lo(e,t),n=i*(s/cs(t)),o=Math.round((r+n)*2)/2;return{over:he(.52),under:he(.48),target:o}}function as(r,e){return Math.round(r*e)}function Gt(r){return`${r.toFixed(2)}x`}function co(r){return{mlb:9,nfl:46,ncaaf:54,nba:220,nhl:6}[r]||10}function cs(r){return{mlb:9,nfl:4,ncaaf:4,nba:4,nhl:3}[r]||4}function lo(r,e){return Math.max(0,cs(e)-r)}class ho{constructor(){this.wallet=this.loadWallet(),this.predictions=new Map,this.disconnectedAt=null,this.regenInterval=null,this.listeners=[],this.loadPredictions(),this.startPassiveRegen()}placePrediction({gameId:e,type:t,choice:i,stake:s,odds:n,gameContext:o}){if(s<$.MIN_STAKE)return{success:!1,error:`Minimum stake is ${$.MIN_STAKE} gold`};if(s>$.MAX_STAKE)return{success:!1,error:`Maximum stake is ${$.MAX_STAKE} gold`};if(s>this.wallet.gold)return{success:!1,error:"Insufficient gold"};if(this.getPendingPredictions().length>=$.MAX_CONCURRENT)return{success:!1,error:`Maximum ${$.MAX_CONCURRENT} concurrent predictions`};if(Array.from(this.predictions.values()).find(h=>h.gameId===e&&h.type===t&&h.status==="pending"))return{success:!1,error:"Already have a prediction on this market"};this.wallet.gold-=s;const l={id:no(),gameId:e,type:t,choice:i,stake:s,odds:n,potentialPayout:as(s,n),status:"pending",placedAt:Date.now(),gameContext:o};return this.predictions.set(l.id,l),this.save(),this.notify(),{success:!0,prediction:l}}handleEvent(e){if(!e.gameContext)return;const t=e.gameContext.gameId,i=Array.from(this.predictions.values()).filter(s=>s.gameId===t&&s.status==="pending");if(i.length!==0)for(const s of i){const n=this.evaluatePrediction(s,e);n!==null&&this.resolvePrediction(s.id,n)}}evaluatePrediction(e,t){const{type:i,choice:s,gameContext:n}=e,{gameContext:o,payload:a}=t;switch(i){case"next_score":{if(t.type!=="GAME_UPDATE")return null;const c=o.homeTeam.score>n.homeScore,l=o.awayTeam.score>n.awayScore;return!c&&!l?null:s==="home"&&c||s==="away"&&l||s==="neither"&&!c&&!l?"won":"lost"}case"game_outcome":{if(t.type!=="GAME_FINAL")return null;const c=o.homeTeam.score>o.awayTeam.score;return s==="home"&&c||s==="away"&&!c?"won":"lost"}case"over_under":{if(t.type!=="GAME_FINAL")return null;const c=o.homeTeam.score+o.awayTeam.score,l=parseFloat(s.split("_")[1]),h=s.split("_")[0];return h==="over"&&c>l||h==="under"&&c<l?"won":c===l?(this.wallet.gold+=e.stake,null):"lost"}case"first_to_score":{if(t.type!=="GAME_UPDATE"||n.homeScore>0||n.awayScore>0)return null;const c=o.homeTeam.score>0,l=o.awayTeam.score>0;return s==="home"&&c||s==="away"&&l?"won":c||l?"lost":null}default:return null}}resolvePrediction(e,t){const i=this.predictions.get(e);!i||i.status!=="pending"||(i.status=t,i.resolvedAt=Date.now(),t==="won"?(this.wallet.gold+=i.potentialPayout,this.wallet.lifetimeEarnings+=i.potentialPayout-i.stake):t==="refunded"?this.wallet.gold+=i.stake:this.wallet.lifetimeLosses+=i.stake,this.save(),this.notify())}handleDisconnect(){this.disconnectedAt=Date.now()}handleReconnect(){if(!this.disconnectedAt)return;const e=Date.now()-this.disconnectedAt;if(this.disconnectedAt=null,e>io){const t=this.getPendingPredictions();for(const i of t)this.resolvePrediction(i.id,"refunded")}}getPendingPredictions(){return Array.from(this.predictions.values()).filter(e=>e.status==="pending")}getResolvedPredictions(e=10){return Array.from(this.predictions.values()).filter(t=>t.status!=="pending").sort((t,i)=>(i.resolvedAt||0)-(t.resolvedAt||0)).slice(0,e)}getWallet(){return{...this.wallet}}getStats(){const e=Array.from(this.predictions.values()).filter(s=>s.status!=="pending"),t=e.filter(s=>s.status==="won").length,i=e.filter(s=>s.status==="lost").length;return{totalBets:e.length,wins:t,losses:i,winRate:e.length>0?t/e.length*100:0,profit:this.wallet.lifetimeEarnings-this.wallet.lifetimeLosses}}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}notify(){const e=Array.from(this.predictions.values());for(const t of this.listeners)t(this.getWallet(),e)}startPassiveRegen(){this.regenInterval||(this.regenInterval=setInterval(()=>{this.wallet.gold<$.PASSIVE_REGEN_CAP&&(this.wallet.gold=Math.min($.PASSIVE_REGEN_CAP,this.wallet.gold+$.PASSIVE_REGEN_RATE),this.save(),this.notify())},6e4))}loadWallet(){try{const e=localStorage.getItem(Ne.WALLET);if(e)return JSON.parse(e)}catch{}return Ft()}loadPredictions(){try{const e=localStorage.getItem(Ne.PREDICTIONS);if(e){const t=JSON.parse(e);for(const i of t)this.predictions.set(i.id,i)}}catch{}}save(){try{localStorage.setItem(Ne.WALLET,JSON.stringify(this.wallet)),localStorage.setItem(Ne.PREDICTIONS,JSON.stringify(Array.from(this.predictions.values())))}catch{}}reset(){this.wallet=Ft(),this.predictions.clear(),this.save(),this.notify()}}const ce=new ho;class uo{constructor(e,t){this.panel=e,this.toggleBtn=t,this.visible=!1,this.activeGames=new Map,this.selectedMarket=null,this.stakeAmount=$.MIN_STAKE,this.init()}init(){var e;(e=this.toggleBtn)==null||e.addEventListener("click",()=>this.toggle()),ce.subscribe((t,i)=>{this.updateBalance(t.gold),this.updatePendingList(i.filter(s=>s.status==="pending")),this.updateHistoryList(i.filter(s=>s.status!=="pending"))}),this.render(),this.updateBalance(ce.getWallet().gold)}toggle(){var e;this.visible=!this.visible,this.panel.hidden=!this.visible,(e=this.toggleBtn)==null||e.setAttribute("aria-pressed",String(this.visible))}show(){var e;this.visible=!0,this.panel.hidden=!1,(e=this.toggleBtn)==null||e.setAttribute("aria-pressed","true")}hide(){var e;this.visible=!1,this.panel.hidden=!0,(e=this.toggleBtn)==null||e.setAttribute("aria-pressed","false")}render(){this.panel.innerHTML=`
      <div class="prediction-content">
        <div class="prediction-markets" id="predictionMarkets">
          <div class="prediction-empty">
            No active games to predict on
          </div>
        </div>

        <div class="prediction-form" id="predictionForm" hidden>
          <div class="prediction-form-header">
            <span class="form-market-type"></span>
            <button class="form-close" type="button">&times;</button>
          </div>
          <div class="prediction-form-body">
            <div class="prediction-options" id="predictionOptions"></div>
            <div class="prediction-stake">
              <label for="stakeInput">Stake</label>
              <div class="stake-input-wrap">
                <input
                  type="number"
                  id="stakeInput"
                  min="${$.MIN_STAKE}"
                  max="${$.MAX_STAKE}"
                  value="${this.stakeAmount}"
                />
                <span class="stake-unit">gold</span>
              </div>
              <div class="stake-quick">
                <button type="button" data-stake="10">10</button>
                <button type="button" data-stake="25">25</button>
                <button type="button" data-stake="50">50</button>
                <button type="button" data-stake="100">100</button>
              </div>
            </div>
            <div class="prediction-payout">
              Potential payout: <span id="potentialPayout">0</span> gold
            </div>
            <button class="prediction-submit" type="button" disabled>
              Place Prediction
            </button>
          </div>
        </div>

        <div class="prediction-pending">
          <div class="section-title">Active Predictions</div>
          <div id="pendingList" class="pending-list"></div>
        </div>

        <div class="prediction-history">
          <div class="section-title">History</div>
          <div id="historyList" class="history-list"></div>
        </div>

        <div class="prediction-stats">
          <div class="stat">
            <span class="stat-label">Win Rate</span>
            <span class="stat-value" id="statWinRate">0%</span>
          </div>
          <div class="stat">
            <span class="stat-label">Profit</span>
            <span class="stat-value" id="statProfit">0</span>
          </div>
        </div>
      </div>
    `,this.attachEventListeners(),this.updateStats()}attachEventListeners(){var t,i;(t=this.panel.querySelector(".form-close"))==null||t.addEventListener("click",()=>{this.closeForm()});const e=this.panel.querySelector("#stakeInput");e==null||e.addEventListener("input",s=>{this.stakeAmount=parseInt(s.target.value,10)||$.MIN_STAKE,this.updatePayout()}),this.panel.querySelectorAll("[data-stake]").forEach(s=>{s.addEventListener("click",()=>{this.stakeAmount=parseInt(s.dataset.stake,10);const n=this.panel.querySelector("#stakeInput");n&&(n.value=this.stakeAmount),this.updatePayout()})}),(i=this.panel.querySelector(".prediction-submit"))==null||i.addEventListener("click",()=>{this.submitPrediction()}),this.panel.addEventListener("click",s=>{const n=s.target.closest(".market-btn");n&&this.selectMarket(n.dataset.gameId,n.dataset.type);const o=s.target.closest(".prediction-option");o&&this.selectOption(o.dataset.choice)})}updateFromEvent(e){var a;if(!e.gameContext)return;const{gameId:t,homeTeam:i,awayTeam:s,status:n,league:o}=e.gameContext;n==="live"?this.activeGames.set(t,{gameId:t,homeTeam:i,awayTeam:s,league:o,homeScore:i.score,awayScore:s.score,winProbability:((a=e.payload)==null?void 0:a.winProbability)||50}):n==="final"&&this.activeGames.delete(t),this.renderMarkets()}renderMarkets(){const e=this.panel.querySelector("#predictionMarkets");if(e){if(this.activeGames.size===0){e.innerHTML=`
        <div class="prediction-empty">
          No active games to predict on
        </div>
      `;return}e.innerHTML=Array.from(this.activeGames.values()).map(t=>this.renderGameMarkets(t)).join("")}}renderGameMarkets(e){const{gameId:t,homeTeam:i,awayTeam:s,homeScore:n,awayScore:o,league:a}=e;return`
      <div class="game-markets">
        <div class="game-header">
          <span class="game-teams">${s.abbreviation} @ ${i.abbreviation}</span>
          <span class="game-score">${o} - ${n}</span>
        </div>
        <div class="market-buttons">
          ${Object.entries(De).map(([c,l])=>`
              <button class="market-btn" data-game-id="${t}" data-type="${c}">
                <span class="market-icon">${l.icon}</span>
                <span class="market-name">${l.name}</span>
              </button>
            `).join("")}
        </div>
      </div>
    `}selectMarket(e,t){const i=this.activeGames.get(e);i&&(this.selectedMarket={gameId:e,type:t,game:i},this.showForm(i,t))}showForm(e,t){const i=this.panel.querySelector("#predictionForm");if(!i)return;const s=De[t];i.querySelector(".form-market-type").textContent=s.name;const n=i.querySelector("#predictionOptions"),o=this.generateOptions(e,t);n.innerHTML=o.map(a=>`
        <button
          class="prediction-option"
          data-choice="${a.choice}"
          data-odds="${a.odds}"
        >
          <span class="option-label">${a.label}</span>
          <span class="option-odds">${Gt(a.odds)}</span>
        </button>
      `).join(""),i.hidden=!1,this.updatePayout()}closeForm(){const e=this.panel.querySelector("#predictionForm");e&&(e.hidden=!0),this.selectedMarket=null}generateOptions(e,t){const{homeTeam:i,awayTeam:s,homeScore:n,awayScore:o,winProbability:a,league:c}=e;switch(t){case"next_score":{const l=Bt(a,0);return[{choice:"home",label:i.abbreviation,odds:l.home},{choice:"away",label:s.abbreviation,odds:l.away}]}case"game_outcome":{const l=ro(a);return[{choice:"home",label:`${i.abbreviation} Win`,odds:l.home},{choice:"away",label:`${s.abbreviation} Win`,odds:l.away}]}case"over_under":{const l=n+o,h=ao(l,5,c);return[{choice:`over_${h.target}`,label:`Over ${h.target}`,odds:h.over},{choice:`under_${h.target}`,label:`Under ${h.target}`,odds:h.under}]}case"first_to_score":{const l=Bt(a,0);return[{choice:"home",label:i.abbreviation,odds:l.home},{choice:"away",label:s.abbreviation,odds:l.away}]}default:return[]}}selectOption(e){this.panel.querySelectorAll(".prediction-option").forEach(s=>{s.classList.toggle("selected",s.dataset.choice===e)});const i=this.panel.querySelector(".prediction-submit");i&&(i.disabled=!1),this.updatePayout()}updatePayout(){const e=this.panel.querySelector(".prediction-option.selected"),t=this.panel.querySelector("#potentialPayout");if(!e||!t)return;const i=parseFloat(e.dataset.odds),s=as(this.stakeAmount,i);t.textContent=s.toString()}submitPrediction(){if(!this.selectedMarket)return;const e=this.panel.querySelector(".prediction-option.selected");if(!e)return;const{gameId:t,type:i,game:s}=this.selectedMarket,n=e.dataset.choice,o=parseFloat(e.dataset.odds),a=ce.placePrediction({gameId:t,type:i,choice:n,stake:this.stakeAmount,odds:o,gameContext:{homeTeam:s.homeTeam.abbreviation,awayTeam:s.awayTeam.abbreviation,homeScore:s.homeScore,awayScore:s.awayScore,league:s.league}});a.success?this.closeForm():alert(a.error)}updateBalance(e){const t=document.getElementById("predictionBalance");t&&(t.textContent=`${e} gold`)}updatePendingList(e){const t=this.panel.querySelector("#pendingList");if(t){if(e.length===0){t.innerHTML='<div class="empty-hint">No active predictions</div>';return}t.innerHTML=e.map(i=>{var s;return`
        <div class="pending-item">
          <div class="pending-info">
            <span class="pending-type">${((s=De[i.type])==null?void 0:s.name)||i.type}</span>
            <span class="pending-choice">${i.choice}</span>
          </div>
          <div class="pending-stake">${i.stake} @ ${Gt(i.odds)}</div>
        </div>
      `}).join("")}}updateHistoryList(e){const t=this.panel.querySelector("#historyList");if(!t)return;const i=e.sort((s,n)=>(n.resolvedAt||0)-(s.resolvedAt||0)).slice(0,5);if(i.length===0){t.innerHTML='<div class="empty-hint">No history yet</div>';return}t.innerHTML=i.map(s=>{var n;return`
        <div class="history-item history-${s.status}">
          <div class="history-info">
            <span class="history-type">${((n=De[s.type])==null?void 0:n.name)||s.type}</span>
            <span class="history-result">${s.status.toUpperCase()}</span>
          </div>
          <div class="history-amount">
            ${s.status==="won"?`+${s.potentialPayout-s.stake}`:`-${s.stake}`}
          </div>
        </div>
      `}).join("")}updateStats(){const e=ce.getStats(),t=this.panel.querySelector("#statWinRate");t&&(t.textContent=`${e.winRate.toFixed(0)}%`);const i=this.panel.querySelector("#statProfit");i&&(i.textContent=e.profit>=0?`+${e.profit}`:e.profit.toString(),i.classList.toggle("positive",e.profit>0),i.classList.toggle("negative",e.profit<0))}}function po(r,e){return new uo(r,e)}let we=!0;async function mo(){const r=new oi,e=document.getElementById("loading"),t=e==null?void 0:e.querySelector(".loading-fill"),i=e==null?void 0:e.querySelector(".loading-text"),s=(m,w)=>{t&&(t.style.width=`${Math.round(m*100)}%`),i&&w&&(i.textContent=w)},n=document.getElementById("mapCanvas"),o=document.getElementById("minimapCanvas");let a=null,c=null,l=null,h=null;if(we)try{s(.1,"Initializing 3D scene..."),a=Ui(n),q.onProgress=(m,w)=>{const M=.15+m/w*.4;s(M,`Loading models (${m}/${w})...`)},s(.2,"Loading 3D models..."),await q.preloadByPriority(2)}catch(m){console.warn("3D init failed, falling back to 2D:",m),we=!1}s(.6,"Initializing 2D renderer...");const d=new gi(we?null:n,o);s(.65,"Loading 2D textures..."),await d.loadTextures(m=>{s(.65+m*.1,"Loading 2D assets...")}),s(.75,"Building city...");const u=new di(660,370);if(d.setCityManager(u),we&&a)try{s(.8,"Setting up building manager..."),c=new Gn(a.scene),await c.sync(u.getAllBuildings()),s(.85,"Setting up worker manager..."),l=new Wn(a.scene),s(.9,"Loading lighting and VFX..."),await ji(a)}catch(m){console.warn("3D setup failed:",m)}const p=document.getElementById("portraitPanel");let f=null;p&&(f=new Mt(p),await Mt.preloadImages()),s(.9,"Connecting to Claude Code..."),Ce.connect();const y=document.getElementById("predictionPanel"),g=document.getElementById("togglePredictions");let b=null;y&&g&&(b=po(y,g));const _=new rs({endpoint:"/api/gamebridge/stream",mode:"spectator",demo:!0,onEvent:m=>{var M,k,V,fe,se;const w=eo(m);if(r.pushEvent(w),b&&b.updateFromEvent(m),ce.handleEvent(m),m.type==="WORLD_TICK"){const U=((M=m.payload)==null?void 0:M.liveGames)||0;r.pushScoutLine(U>0?`${U} live game${U===1?"":"s"} in progress.`:"No live games. SimFeed generating events.")}else m.type==="GAME_START"&&m.gameContext?r.pushScoutLine(`Game started: ${(k=m.gameContext.awayTeam)==null?void 0:k.name} @ ${(V=m.gameContext.homeTeam)==null?void 0:V.name}`):m.type==="INJURY_ALERT"&&r.pushScoutLine(`Alert: ${(fe=m.payload)==null?void 0:fe.playerName} injury (${(se=m.payload)==null?void 0:se.severity})`)},onStats:m=>{u.updateProgress(m),c&&c.sync(u.getAllBuildings())},onConnection:m=>{const w=document.getElementById("bridgeStatus");w&&(w.textContent=m?"BSI Live":"BSI Demo",w.classList.toggle("tag-live",m)),m?ce.handleReconnect():ce.handleDisconnect()},onError:m=>{console.warn("[GameBridge] Error:",m.message)}}),S=new Ai(r),T=new Ti(r,S),D=new bi(r,d);s(1,"Ready!"),setTimeout(()=>{e&&e.classList.add("hidden")},300),Ce.onStats(m=>{u.updateProgress(m),c&&c.sync(u.getAllBuildings())}),Ce.onConnection(m=>{const w=document.getElementById("logStatus");w&&(w.textContent=m?"Live":"Demo",w.classList.toggle("tag-live",m))}),r.subscribe(()=>{if(D.render(),u.updateProgress(r.getEventStats()),f){const m=r.getSelectedWorkers();f.updateFromWorkers(m)}});const C=document.getElementById("toggleLog");C==null||C.addEventListener("click",()=>{const m=document.body.classList.toggle("log-collapsed");C.setAttribute("aria-pressed",String(!m))});let L=!0;const A=document.getElementById("toggleDemo");A==null||A.addEventListener("click",async()=>{if(L=!L,A.setAttribute("aria-pressed",String(L)),L)await S.connect(),r.pushScoutLine("Demo mode resumed. Workers rallying.");else{S.disconnect(),r.setSelected([]);for(const m of Array.from(r.workers.keys()))r.removeWorker(m);r.events=[],r.pushScoutLine("Demo mode paused. Listening for real events."),r.notify()}});const E=document.querySelectorAll("[data-bridge-mode]");E.forEach(m=>{m.addEventListener("click",()=>{const w=m.getAttribute("data-bridge-mode");w&&(_.setMode(w),E.forEach(M=>M.classList.remove("active")),m.classList.add("active"),r.pushScoutLine(`Switched to ${w} mode.`))})});const x=document.getElementById("toggleBsiDemo");if(x==null||x.addEventListener("click",()=>{const m=_.demoMode;_.setDemoMode(!m),x.setAttribute("aria-pressed",String(!m)),r.pushScoutLine(m?"BSI: Switching to live data...":"BSI: Switching to SimFeed...")}),_.connect(),ae.hasFaction()){const m=ae.getFaction();m&&r.pushScoutLine(`Faction loaded: ${m.teamId.split("-")[1]}`)}else{const m=await Ot(document.body);m.teamId&&m.league?(ae.setFaction(m.teamId,m.league),r.pushScoutLine(`Faction selected: ${m.teamId.split("-")[1]}`)):r.pushScoutLine("Playing without faction bonuses.")}const I=document.getElementById("factionBtn");I==null||I.addEventListener("click",async()=>{const m=await Ot(document.body);m.teamId&&m.league&&(ae.setFaction(m.teamId,m.league),r.pushScoutLine(`Faction changed: ${m.teamId.split("-")[1]}`),P())});function P(){const m=document.getElementById("factionIndicator");if(!m)return;const w=ae.getFaction();if(w){const M=w.teamId.split("-")[1];m.innerHTML=`<span class="faction-indicator-abbr">${M}</span>`,m.title=`Current faction: ${M}`}else m.innerHTML='<span class="faction-indicator-empty">No Faction</span>',m.title="Click to select a faction"}if(P(),ae.subscribe(()=>P()),await S.connect(),fo(n,o,d,a,c,l,r,T),go(T,a),we&&a)h=Xi(a,m=>{const w=performance.now();c&&c.update(m,w),l&&(l.sync(Array.from(r.workers.values())),l.update(m,w)),d.render(r)});else{let m=function(){d.render(r),requestAnimationFrame(m)};requestAnimationFrame(m)}d.camera.x=d.world.w/2,d.camera.y=d.world.h/2,Ue(d,n),window.addEventListener("resize",()=>{a&&zi(a,n.width,n.height)}),window.addEventListener("beforeunload",()=>{Ce.disconnect(),_.disconnect(),S.disconnect(),h&&h(),l&&l.dispose(),c&&c.dispose(),q.dispose()})}function fo(r,e,t,i,s,n,o,a){let c=!1,l={x:0,y:0,cx:0,cy:0},h=!1,d={x:0,y:0};r.addEventListener("contextmenu",u=>u.preventDefault()),r.addEventListener("mousedown",u=>{if(u.button===1){c=!0,i?l={x:u.clientX,y:u.clientY,cx:0,cy:0}:l={x:u.clientX,y:u.clientY,cx:t.camera.x,cy:t.camera.y};return}if(u.button===2){if(!i){const p=t.screenToWorld(u.clientX,u.clientY),f=t.regionAt(p.x,p.y);f&&o.selected.size&&a.assignSelectedTo(f)}return}if(u.button===0){if(r.focus(),i){const y=r.getBoundingClientRect(),g=new H((u.clientX-y.left)/y.width*2-1,-((u.clientY-y.top)/y.height)*2+1),b=new ni;if(b.setFromCamera(g,i.camera),n){const _=n.raycast(b);if(_){o.setSelected([_]),n.select([_]),a.assignMode=!1;return}}if(s){const _=s.raycast(b);if(_){s.select(_);return}}}const p=t.screenToWorld(u.clientX,u.clientY),f=yo(o,p.x,p.y);if(f){o.setSelected([f.id]),a.assignMode=!1,t.setSelection(!1,0,0,0,0);return}h=!0,d={x:p.x,y:p.y},t.setSelection(!0,p.x,p.y,p.x,p.y)}}),window.addEventListener("mousemove",u=>{if(c&&!i){const p=(u.clientX-l.x)/t.camera.zoom,f=(u.clientY-l.y)/t.camera.zoom;t.camera.x=l.cx-p,t.camera.y=l.cy-f,Ue(t,r)}if(h){const p=t.screenToWorld(u.clientX,u.clientY);t.setSelection(!0,d.x,d.y,p.x,p.y)}}),window.addEventListener("mouseup",u=>{if(u.button===1&&(c=!1),u.button===0&&h){h=!1;const p=t.selection,f=Math.min(p.x0,p.x1),y=Math.min(p.y0,p.y1),g=Math.max(p.x0,p.x1),b=Math.max(p.y0,p.y1),_=[],S=[];for(const T of o.workers.values())T.position.x>=f&&T.position.x<=g&&T.position.y>=y&&T.position.y<=b&&(_.push(T.id),S.push({x:T.position.x,y:T.position.y}));o.setSelected(_),t.setSelection(!1,0,0,0,0),S.length>0&&t.spawnSelectionPulses(S)}}),r.addEventListener("wheel",u=>{if(u.preventDefault(),i)return;const p=u.deltaY<0?1.12:.89,f=t.camera.zoom,y=le(f*p,.7,2.2),g=t.screenToWorld(u.clientX,u.clientY);t.camera.zoom=y;const b=t.screenToWorld(u.clientX,u.clientY);t.camera.x+=g.x-b.x,t.camera.y+=g.y-b.y,Ue(t,r)},{passive:!1}),e.addEventListener("mousedown",u=>{const p=t.minimapToWorld(u.clientX,u.clientY);bo(t,r,p.x,p.y,280)})}function go(r,e){window.addEventListener("keydown",t=>{if(t.target&&t.target.tagName==="INPUT")return;const i=t.key.toLowerCase();i==="s"&&r.exec("stop"),i==="h"&&r.exec("hold"),i==="r"&&r.exec("resume"),i==="a"&&r.exec("reassign"),i==="i"&&r.exec("inspect"),i==="x"&&r.exec("terminate"),i==="g"&&e&&Ki(e.scene)});for(const t of Array.from(document.querySelectorAll("button.cmd[data-cmd]")))t.addEventListener("click",()=>{const i=t.getAttribute("data-cmd");r.exec(i)})}function yo(r,e,t){let i=null,s=999999;for(const n of r.workers.values()){const o=n.position.x-e,a=n.position.y-t,c=Math.hypot(o,a);c<14&&c<s&&(i=n,s=c)}return i}function Ue(r,e){const{w:t,h:i}=r.world,s=e.getBoundingClientRect(),n=s.width/r.camera.zoom,o=s.height/r.camera.zoom;r.camera.x=le(r.camera.x,n/2,t-n/2),r.camera.y=le(r.camera.y,o/2,i-o/2)}let ue=null;function bo(r,e,t,i,s=300){ue&&(cancelAnimationFrame(ue),ue=null);const n=r.camera.x,o=r.camera.y,a=performance.now();function c(l){const h=Math.min(1,(l-a)/s),d=h*(2-h);r.camera.x=n+(t-n)*d,r.camera.y=o+(i-o)*d,Ue(r,e),h<1?ue=requestAnimationFrame(c):ue=null}ue=requestAnimationFrame(c)}mo();
//# sourceMappingURL=index-D0Moz3tF.js.map
